<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Integrado | Flor de Maira</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- PROFESSIONAL BLUE GRADIENT THEME --- */
        :root {
            --primary-color: #3b82f6; /* Blue 500 */
            --primary-dark-color: #2563eb; /* Blue 600 */
            --primary-light-color: #eff6ff; /* Blue 50 */
            --primary-gradient-start: #3b82f6; /* Blue 500 */
            --primary-gradient-end: #2563eb; /* Blue 600 */
            
            --text-primary: #1f2937; /* Gray 800 */
            --text-secondary: #6b7280; /* Gray 500 */
            
            --bg-color: #f9fafb; /* Gray 50 */
            --surface-color: #ffffff;
            --border-color: #e5e7eb; /* Gray 200 */
            --shadow-color: rgba(0,0,0,0.08); /* Slightly darker shadow for contrast */

            --success-color: #10b981; /* Green 500 */
            --danger-color: #ef4444; /* Red 500 */
            --warning-color: #f59e0b; /* Amber 500 */
            --info-color: #60a5fa; /* Blue 400 (slightly lighter for info) */
        }

        /* --- Dark Theme --- */
        body.dark-theme {
            --primary-color: #60a5fa; /* Lighter blue for contrast */
            --primary-dark-color: #3b82f6; /* Original primary blue */
            --primary-light-color: #1e3a8a; /* Darker blue background for highlight */
            --primary-gradient-start: #1e3a8a;
            --primary-gradient-end: #172554;
            
            --text-primary: #f8fafc; /* Lighter text */
            --text-secondary: #94a3b8; /* Lighter gray text */
            
            --bg-color: #1f2937; /* Darker background */
            --surface-color: #374151; /* Darker card/surface background */
            --border-color: #4b5563; /* Darker borders */
            --shadow-color: rgba(0,0,0,0.3); /* More prominent shadow in dark theme */

            /* Keep success, danger, warning, info colors similar for consistency */
        }

        /* --- BASE STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body {
            height: 100%;
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            background-color: var(--bg-color);
            -webkit-font-smoothing: antialiased;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* --- UTILITY CLASSES --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .justify-center { justify-content: center; }
        .items-center { align-items: center; }
        .gap-2 { gap: 1rem; }
        .gap-4 { gap: 2rem; }
        .align-items-end { align-items: flex-end; }
        .flex-1 { flex: 1; }
        .mt-3 { margin-top: 1.5rem; }
        .mt-4 { margin-top: 2rem; }
        .mb-2 { margin-bottom: 1rem; }
        .p-4 { padding: 1rem; }
        .text-center { text-align: center; }
        .rounded-lg { border-radius: 0.5rem; }
        .shadow-md { box-shadow: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -2px var(--shadow-color); }
        .shadow-lg { box-shadow: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -4px var(--shadow-color); }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            background: linear-gradient(135deg, var(--primary-gradient-start), var(--primary-gradient-end));
            display: flex; justify-content: center; align-items: center;
            height: 100%; padding: 1rem;
        }
        .login-box {
            background-color: var(--surface-color); padding: 40px; border-radius: 12px;
            box-shadow: var(--shadow-lg);
            text-align: center; width: 100%; max-width: 400px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .login-box h1 { font-size: 2.5rem; font-weight: 700; color: var(--primary-dark-color); margin-bottom: 10px;}
        .login-box .subtitle { color: var(--text-secondary); margin-bottom: 35px; font-size: 1rem; }
        .input-group { position: relative; margin-bottom: 35px; }
        .input-group input {
            width: 100%; padding: 10px 5px; border: none; border-bottom: 2px solid var(--border-color);
            background-color: transparent; font-size: 1rem; position: relative; z-index: 1; transition: border-color 0.3s, background-color 0.3s;
            color: var(--text-primary);
        }
        .input-group label { position: absolute; left: 5px; top: 10px; color: var(--text-secondary); pointer-events: none; transition: all 0.3s ease; }
        .input-group input:focus { outline: none; border-bottom-color: var(--primary-color); }
        .input-group input:focus ~ label, .input-group input:valid ~ label {
            transform: translateY(-24px); font-size: 0.8rem; color: var(--primary-color);
        }
        .btn-login {
            width: 100%; padding: 14px; border: none; border-radius: 8px;
            background: var(--primary-color); color: white; font-size: 1.1rem;
            font-weight: 600; cursor: pointer; transition: background 0.3s ease, transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4);
        }
        .btn-login:hover { background: var(--primary-dark-color); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(37, 99, 235, 0.5); }
        .btn-login:active { transform: translateY(0); box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3); }
        .error-message { color: var(--danger-color); margin-top: 15px; height: 20px; font-size: 0.9rem; font-weight: 500; }

        /* --- DASHBOARD LAYOUT --- */
        #dashboard-screen { display: flex; height: 100vh; background-color: var(--bg-color); }
        
        .sidebar {
            width: 260px; background: var(--surface-color); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; padding: 20px 15px;
            flex-shrink: 0; transition: transform 0.3s ease-in-out, background-color 0.3s ease, border-color 0.3s ease;
            z-index: 1000;
        }
        .sidebar-header { text-align: center; margin-bottom: 30px; }
        .sidebar-header h2 { color: var(--primary-color); font-weight: 700; font-size: 1.8rem; }
        .sidebar-nav ul { list-style: none; padding: 0; }
        .sidebar-nav li a {
            display: flex; align-items: center; gap: 12px; padding: 12px 15px;
            color: var(--text-secondary); text-decoration: none; border-radius: 8px;
            margin-bottom: 6px; transition: all 0.2s ease; font-weight: 500; font-size: 0.95rem;
        }
        .sidebar-nav li a .icon { width: 20px; height: 20px; stroke-width: 2; }
        .sidebar-nav li a:hover { background-color: var(--primary-light-color); color: var(--primary-dark-color); transform: translateX(5px); }
        .sidebar-nav li a.active { background-color: var(--primary-color); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .sidebar-footer { margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .logout-btn {
            display: flex; align-items: center; justify-content: center; gap: 12px;
            width: 100%; padding: 12px; border: 1px solid var(--border-color);
            background: transparent; color: var(--text-secondary); border-radius: 8px;
            cursor: pointer; font-size: 1rem; font-weight: 500; transition: all 0.2s ease;
        }
        .logout-btn:hover { background-color: var(--danger-color); color: white; border-color: var(--danger-color); transform: translateY(-2px); }
        .logout-btn:active { transform: translateY(0); }
        
        .main-content { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .main-header { 
            display: flex; align-items: center; justify-content: space-between; 
            margin-bottom: 30px; 
            background-color: var(--surface-color);
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
        }
        .mobile-header { display: none; align-items: center; gap: 15px; }
        #menu-toggle { background: none; border: none; cursor: pointer; padding: 0.5rem; }
        #menu-toggle .bar { display: block; width: 25px; height: 3px; background-color: var(--text-primary); margin: 5px 0; transition: 0.4s; border-radius: 2px; }
        
        .main-content h1 { font-size: 2rem; color: var(--text-primary); font-weight: 700; }

        /* --- CONTENT SECTIONS --- */
        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CARD STYLES --- */
        .card { 
            background: var(--surface-color); padding: 25px; border-radius: 12px; 
            margin-top: 20px; border: 1px solid var(--border-color); 
            box-shadow: var(--shadow-md);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .card h2 { margin-bottom: 20px; color: var(--text-primary); font-weight: 700; font-size: 1.5rem; }
        .card h3 { font-weight: 600; color: var(--text-primary); }

        /* --- FORM STYLES --- */
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); font-size: 0.9rem; }
        .form-group input, .form-group select {
            width: 100%; padding: 12px 15px; border: 1px solid var(--border-color);
            border-radius: 8px; font-size: 1rem; font-family: 'Inter', sans-serif;
            background-color: var(--surface-color); color: var(--text-primary);
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light-color);
        }
        .form-actions {
            margin-top: 1.5rem;
            display: flex;
            gap: 10px;
        }

        /* --- BUTTON STYLES --- */
        .btn, .btn-submit {
            padding: 12px 25px; border: none; border-radius: 8px; background: var(--primary-color);
            color: white; font-size: 1rem; cursor: pointer; transition: background 0.2s, transform 0.2s, box-shadow 0.2s; font-weight: 600;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.2);
        }
        .btn:hover, .btn-submit:hover { background: var(--primary-dark-color); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(37, 99, 235, 0.3); }
        .btn:active, .btn-submit:active { transform: translateY(0); box-shadow: 0 2px 5px rgba(59, 130, 246, 0.1); }
        .btn-secondary {
            background-color: var(--text-secondary);
            box-shadow: 0 4px 10px rgba(107, 114, 128, 0.2);
        }
        .btn-secondary:hover {
            background-color: #5a6a7c; /* slightly darker slate */
            box-shadow: 0 6px 15px rgba(107, 114, 128, 0.3);
        }
        
        /* --- TABLE STYLES --- */
        .table-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        .table-controls .form-group {
            margin-bottom: 0;
        }
        .table-controls input, .table-controls select {
            padding: 10px 12px;
            font-size: 0.9rem;
        }

        .table-responsive-container { overflow-x: auto; margin-top: 20px;}
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th, td { 
            padding: 15px 20px; text-align: left; 
            border-bottom: 1px solid var(--border-color);
        }
        th { 
            background-color: var(--primary-light-color); font-weight: 600; color: var(--primary-dark-color); 
            font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;
            position: sticky; top: 0;
        }
        td { color: var(--text-primary); font-size: 0.95rem; }
        tr:nth-child(even) { background-color: rgba(0,0,0,0.02); }

        .btn-action { padding: 8px 12px; border-radius: 6px; color: white; font-weight: 500; border: none; cursor: pointer; margin-right: 8px; transition: background-color 0.2s, transform 0.2s;}
        .btn-action:hover { transform: translateY(-1px); }
        .btn-action:active { transform: translateY(0); }
        .btn-paid { background-color: var(--success-color); }
        .btn-paid:hover { background-color: #0c9b6f; }
        .btn-edit { background-color: var(--info-color); }
        .btn-edit:hover { background-color: #3b82f6; } /* Matching primary blue for edit */
        .btn-delete { background-color: var(--danger-color); }
        .btn-delete:hover { background-color: #cc3939; }
        .status-pendente { color: var(--warning-color); font-weight: bold; }
        .status-pago { color: var(--success-color); font-weight: bold; }
        .status-aberta { color: var(--warning-color); font-weight: bold; }
        .status-paga { color: var(--success-color); font-weight: bold; }
        .valor-entrada { color: var(--success-color); font-weight: 600; }
        .valor-saida { color: var(--danger-color); font-weight: 600; }
        
        /* Pagination */
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        .pagination-controls button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .pagination-controls button:hover:not(:disabled) {
            background-color: var(--primary-dark-color);
        }
        .pagination-controls button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }
        .pagination-controls span {
            color: var(--text-primary);
            font-weight: 500;
        }

        /* --- DASHBOARD SPECIFIC --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
        .summary-card { 
            padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);
            background-color: var(--surface-color); box-shadow: var(--shadow-md);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .summary-card h3 { font-size: 0.95rem; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .summary-card p { font-size: 2rem; font-weight: 700; color: var(--text-primary); }
        
        .dashboard-main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 20px; }
        #sales-summary-container .summary-card { 
            padding: 15px; 
            margin-bottom: 1rem; 
            box-shadow: none;
            border: 1px dashed var(--border-color); /* Lighter border for inner cards */
        }
        #sales-summary-container .summary-card:last-child {
            margin-bottom: 0;
        }
        #sales-summary-container .summary-card p { font-size: 1.5rem; }

        /* --- SETTINGS SPECIFIC --- */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .settings-card {
            background: var(--surface-color);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
        }
        .settings-card h3 {
            margin-bottom: 15px;
            font-size: 1.25rem;
            color: var(--text-primary);
        }
        .settings-card .btn {
            width: 100%;
            margin-top: 15px;
        }
        #backup-file-input {
            margin-top: 10px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-color);
            color: var(--text-primary);
            width: 100%;
        }
        .theme-toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1001; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
            animation: fadeInModal 0.3s ease-out;
        }

        .modal-content {
            background-color: var(--surface-color);
            margin: auto;
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 600px;
            position: relative;
            animation: slideInTop 0.3s ease-out;
        }

        .close-button {
            color: var(--text-secondary);
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 15px;
            right: 20px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--danger-color);
            text-decoration: none;
            cursor: pointer;
        }

        @keyframes fadeInModal {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInTop {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Specific modal content styling */
        #modal-venda-detalhes h2 {
            font-size: 1.8rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }
        #modal-venda-detalhes p {
            margin-bottom: 8px;
            font-size: 1rem;
            color: var(--text-primary);
        }
        #modal-venda-detalhes p strong {
            color: var(--primary-dark-color);
        }
        #modal-venda-detalhes .table-responsive-container {
            margin-top: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden; /* For rounded corners on table */
        }
        #modal-venda-detalhes table {
            width: 100%;
            border-collapse: collapse;
        }
        #modal-venda-detalhes th, #modal-venda-detalhes td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }
        #modal-venda-detalhes th {
            background-color: var(--primary-light-color);
            color: var(--primary-dark-color);
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        #modal-venda-detalhes tr:last-child td {
            border-bottom: none;
        }
        #modal-venda-detalhes .modal-total {
            text-align: right;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-top: 20px;
        }

        /* --- MEDIA QUERIES --- */
        @media (max-width: 1024px) {
            .dashboard-main-grid { grid-template-columns: 1fr; }
            .table-controls { flex-direction: column; align-items: stretch;}
            .table-controls .form-group { width: 100%;}
            .table-controls button { width: 100%; margin-top: 0.5rem;}
        }
        @media (max-width: 768px) {
            .sidebar { 
                position: fixed; height: 100%; width: 240px; 
                transform: translateX(-100%); 
                box-shadow: 0 10px 15px -3px var(--shadow-color); 
                border-right: none;
            }
            .sidebar.open { transform: translateX(0); }
            .main-content { padding: 20px; }
            .main-header { justify-content: flex-start; padding: 15px; }
            .desktop-title { display: none; }
            .mobile-header { display: flex; }
            .dashboard-grid { grid-template-columns: 1fr 1fr; }
            .flex.gap-2 { flex-direction: column; gap: 0.5rem; } /* Adjust flex for small screens */
            .align-items-end { align-items: stretch; }
            .align-items-end .btn { margin-top: 0.5rem; }
            .form-actions { flex-direction: column; }
            .btn, .btn-submit { width: 100%; }
        }
        @media (max-width: 480px) {
             .dashboard-grid { grid-template-columns: 1fr; }
             .login-box { padding: 30px 20px; }
             .login-box h1 { font-size: 2rem; }
             .input-group { margin-bottom: 25px; }
             .main-content { padding: 15px; }
             .card { padding: 15px; }
             .card h2 { font-size: 1.3rem; margin-bottom: 15px; }
             th, td { padding: 10px 12px; font-size: 0.9rem; }
             .btn-action { padding: 6px 10px; margin-right: 3px;}
             .settings-grid { grid-template-columns: 1fr; }
             .modal-content {
                width: 95%;
                padding: 20px;
             }
        }

    </style>
</head>
<body>
    <div id="login-screen" class="hidden">
        <div class="login-box">
            <h1>Flor de Maira</h1>
            <p class="subtitle">Acesse seu painel de gestão</p>
            <form id="login-form">
                <div class="input-group">
                    <input type="text" id="username" required>
                    <label for="username">Usuário</label>
                </div>
                <div class="input-group">
                    <input type="password" id="password" required>
                    <label for="password">Senha</label>
                </div>
                <button type="submit" class="btn-login">Entrar</button>
                <p id="error-message" class="error-message"></p>
            </form>
        </div>
    </div>

    <div id="dashboard-screen" class="hidden">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header"><h2>Flor de Maira</h2></div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="#dashboard" class="nav-link active" data-target="dashboard-view"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg><span>Dashboard</span></a></li>
                    <li><a href="#caixa" class="nav-link" data-target="caixa-view"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><span>Fluxo de Caixa</span></a></li>
                    <li><a href="#vendas" class="nav-link" data-target="vendas-view"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><span>Realizar Venda</span></a></li>
                    <li><a href="#clientes" class="nav-link" data-target="clientes-view"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><span>Clientes</span></a></li>
                    <li><a href="#estoque" class="nav-link" data-target="estoque-view"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg><span>Estoque</span></a></li>
                    <li><a href="#contas-a-receber" class="nav-link" data-target="contas-a-receber-view"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1h4a2 2 0 012 2v11a2 2 0 01-2 2H8a2 2 0 01-2-2V8a2 2 0 012-2h4z"></path></svg><span>Contas a Receber</span></a></li>
                    <li><a href="#contas-a-pagar" class="nav-link" data-target="contas-a-pagar-view"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 14l6-6m-6 6l6-6M9 20v-1a3 3 0 013-3h2a3 3 0 013 3v1M21 12h-4v-.01M3 12h4v-.01M12 6V3M6 18H4a2 2 0 01-2-2V7a2 2 0 012-2h4M18 18h2a2 2 0 002-2V7a2 2 0 00-2-2h-4"></path></svg><span>Contas a Pagar</span></a></li>
                    <li><a href="#relatorios" class="nav-link" data-target="relatorios-view"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span>Relatórios</span></a></li>
                    <li><a href="#configuracoes" class="nav-link" data-target="configuracoes-view"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.294.542 2.573-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg><span>Configurações</span></a></li>
                </ul>
            </nav>
            <div class="sidebar-footer"><button class="logout-btn" id="logout-btn"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg><span>Sair</span></button></div>
        </aside>

        <main class="main-content" id="main-content">
            <header class="main-header">
                <div class="mobile-header">
                    <button id="menu-toggle"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>
                    <h1 id="mobile-page-title"></h1>
                </div>
                <h1 class="desktop-title" id="desktop-page-title"></h1>
            </header>
            
            <section id="dashboard-view" class="content-section">
                <div class="dashboard-grid">
                    <div class="summary-card"><h3 style="color:var(--success-color);">Saldo em Caixa</h3><p id="saldo-caixa-dashboard">R$ 0,00</p></div>
                    <div class="summary-card"><h3 style="color:var(--warning-color);">Total a Receber</h3><p id="total-a-receber-dashboard">R$ 0,00</p></div>
                    <div class="summary-card"><h3 style="color:var(--danger-color);">Total a Pagar</h3><p id="total-a-pagar-dashboard">R$ 0,00</p></div>
                </div>
                <div class="dashboard-main-grid">
                    <div class="card"><h2>Vendas por Método de Pagamento</h2><div style="height:300px;"><canvas id="paymentMethodChart"></canvas></div></div>
                    <div class="card"><h2>Resumo de Vendas</h2><div id="sales-summary-container"></div></div>
                </div>
            </section>
            
            <section id="caixa-view" class="content-section">
                <div class="card"><h2>Saldo Atual: <span id="saldo-caixa-detalhe" style="color: var(--primary-color);">R$ 0,00</span></h2></div>
                <div class="card">
                    <h2>Adicionar Lançamento Manual</h2>
                    <form id="form-add-lancamento">
                        <input type="hidden" id="lancamento-id">
                        <div class="flex gap-2">
                            <div class="form-group flex-1">
                                <label for="desc-lancamento">Descrição</label>
                                <input type="text" id="desc-lancamento" required>
                            </div>
                            <div class="form-group">
                                <label for="valor-lancamento">Valor (R$)</label>
                                <input type="number" step="0.01" id="valor-lancamento" required min="0.01">
                            </div>
                            <div class="form-group">
                                <label for="tipo-lancamento">Tipo</label>
                                <select id="tipo-lancamento">
                                    <option value="Entrada">Entrada</option>
                                    <option value="Saída">Saída</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn-submit" id="btn-salvar-lancamento">Lançar</button>
                            <button type="button" class="btn btn-secondary" id="btn-cancelar-lancamento" style="display:none;">Cancelar Edição</button>
                        </div>
                    </form>
                </div>
                <div class="card">
                    <h2>Histórico de Movimentações</h2>
                    <div class="table-controls">
                        <div class="form-group flex-1">
                            <label for="search-caixa">Buscar</label>
                            <input type="text" id="search-caixa" placeholder="Buscar por descrição...">
                        </div>
                        <div class="form-group">
                            <label for="filter-caixa-tipo">Tipo</label>
                            <select id="filter-caixa-tipo">
                                <option value="">Todos</option>
                                <option value="Entrada">Entrada</option>
                                <option value="Saída">Saída</option>
                            </select>
                        </div>
                    </div>
                    <div id="tabela-caixa-container" class="table-responsive-container"></div>
                    <div id="pagination-caixa" class="pagination-controls"></div>
                </div>
            </section>

            <section id="clientes-view" class="content-section">
                <div class="card">
                    <h2>Cadastrar/Editar Cliente</h2>
                    <form id="form-add-cliente">
                        <input type="hidden" id="cliente-id">
                        <div class="form-group">
                            <label for="nome-cliente">Nome</label>
                            <input type="text" id="nome-cliente" required>
                        </div>
                        <div class="form-group">
                            <label for="contato-cliente">Telefone ou E-mail</label>
                            <input type="text" id="contato-cliente">
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn-submit" id="btn-salvar-cliente">Salvar Cliente</button>
                            <button type="button" class="btn btn-secondary" id="btn-cancelar-cliente" style="display:none;">Cancelar Edição</button>
                        </div>
                    </form>
                </div>
                <div class="card">
                    <h2>Clientes Cadastrados</h2>
                    <div class="table-controls">
                        <div class="form-group flex-1">
                            <label for="search-clientes">Buscar</label>
                            <input type="text" id="search-clientes" placeholder="Buscar por nome ou contato...">
                        </div>
                    </div>
                    <div id="tabela-clientes-container" class="table-responsive-container"></div>
                    <div id="pagination-clientes" class="pagination-controls"></div>
                </div>
            </section>

            <section id="estoque-view" class="content-section">
                <div class="card">
                    <h2>Cadastrar/Editar Produto</h2>
                    <form id="form-add-produto">
                        <input type="hidden" id="produto-id">
                        <div class="flex gap-2">
                            <div class="form-group flex-1">
                                <label for="nome-produto">Nome do Produto</label>
                                <input type="text" id="nome-produto" required>
                            </div>
                            <div class="form-group">
                                <label for="qtd-produto">Quantidade</label>
                                <input type="number" id="qtd-produto" required min="0">
                            </div>
                            <div class="form-group flex-1">
                                <label for="preco-produto">Preço (R$)</label>
                                <input type="number" step="0.01" id="preco-produto" required min="0.01">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn-submit" id="btn-salvar-produto">Adicionar/Atualizar Produto</button>
                            <button type="button" class="btn btn-secondary" id="btn-cancelar-produto" style="display:none;">Cancelar Edição</button>
                        </div>
                    </form>
                </div>
                <div class="card">
                    <h2>Atualizar Estoque Manualmente</h2>
                    <form id="form-update-stock">
                        <div class="flex gap-2 align-items-end">
                            <div class="form-group flex-1">
                                <label for="update-stock-product">Produto</label>
                                <select id="update-stock-product" required>
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="update-stock-quantity">Quantidade</label>
                                <input type="number" id="update-stock-quantity" required value="1" min="1">
                            </div>
                            <div class="form-group">
                                <label for="update-stock-type">Tipo</label>
                                <select id="update-stock-type" required>
                                    <option value="add">Adicionar</option>
                                    <option value="remove">Remover</option>
                                </select>
                            </div>
                            <button type="submit" class="btn">Atualizar</button>
                        </div>
                    </form>
                </div>
                <div class="card">
                    <h2>Produtos em Estoque</h2>
                     <div class="table-controls">
                        <div class="form-group flex-1">
                            <label for="search-produtos">Buscar</label>
                            <input type="text" id="search-produtos" placeholder="Buscar por nome...">
                        </div>
                        <div class="form-group">
                            <label for="filter-estoque-qtd">Estoque</label>
                            <select id="filter-estoque-qtd">
                                <option value="">Todos</option>
                                <option value="low">Baixo (&lt; 10)</option>
                                <option value="empty">Esgotado (0)</option>
                            </select>
                        </div>
                    </div>
                    <div id="tabela-produtos-container" class="table-responsive-container"></div>
                    <div id="pagination-produtos" class="pagination-controls"></div>
                </div>
            </section>

            <section id="vendas-view" class="content-section">
                <div class="card" id="venda-form-card">
                    <form id="venda-form">
                        <div class="form-group"><label for="venda-cliente">Selecione o Cliente</label><select id="venda-cliente" required></select></div>
                        <div class="card mt-3"><h3>Adicionar Item</h3><div class="flex gap-2 align-items-end"><div class="form-group flex-1"><label for="venda-produto">Produto</label><select id="venda-produto"></select></div><div class="form-group"><label for="venda-qtd">Qtd.</label><input type="number" id="venda-qtd" value="1" min="1" style="width: 80px;"></div><button type="button" id="btn-add-item-venda" class="btn">Adicionar</button></div></div>
                        <div class="card mt-3"><h3>Itens da Venda</h3><div id="venda-itens-container" class="table-responsive-container"></div><h3 style="margin-top:1rem; text-align:right; font-weight:700; font-size:1.125rem;">Total: <span id="venda-total">R$ 0,00</span></h3></div>
                        <div class="card mt-3"><h3>Pagamento</h3><div class="form-group"><label for="venda-pagamento">Método</label><select id="venda-pagamento"><option value="vista">À Vista</option><option value="pix">Pix</option><option value="fiado">Fiado</option><option value="parcelado">Parcelado</option></select></div><div class="form-group hidden" id="venda-parcelas-group"><label for="venda-parcelas">Parcelas</label><select id="venda-parcelas"><option value="2">2x</option><option value="3">3x</option><option value="4">4x</option><option value="5">5x</option><option value="6">6x</option><option value="7">7x</option><option value="8">8x</option><option value="9">9x</option><option value="10">10x</option><option value="11">11x</option><option value="12">12x</option></select></div></div>
                        <button type="button" id="btn-finalizar-venda" class="btn-submit" style="margin-top:1.5rem; width:100%;">Finalizar Venda</button>
                    </form>
                </div>
            </section>
            
            <section id="contas-a-receber-view" class="content-section">
                <div class="card">
                    <h2>Contas a Receber</h2>
                    <div class="table-controls">
                        <div class="form-group flex-1">
                            <label for="search-contas-receber">Buscar</label>
                            <input type="text" id="search-contas-receber" placeholder="Buscar por cliente...">
                        </div>
                        <div class="form-group">
                            <label for="filter-contas-receber-status">Status</label>
                            <select id="filter-contas-receber-status">
                                <option value="">Todos</option>
                                <option value="Pendente">Pendente</option>
                                <option value="Pago">Pago</option>
                            </select>
                        </div>
                    </div>
                    <div id="tabela-contas-container" class="table-responsive-container"></div>
                    <div id="pagination-contas-receber" class="pagination-controls"></div>
                </div>
            </section>

            <section id="contas-a-pagar-view" class="content-section">
                <div class="card">
                    <h2>Registrar/Editar Conta a Pagar</h2>
                    <form id="form-add-conta-pagar">
                        <input type="hidden" id="conta-pagar-id">
                        <div class="flex gap-2">
                            <div class="form-group flex-1">
                                <label for="desc-conta-pagar">Descrição</label>
                                <input type="text" id="desc-conta-pagar" required>
                            </div>
                            <div class="form-group">
                                <label for="valor-conta-pagar">Valor (R$)</label>
                                <input type="number" step="0.01" id="valor-conta-pagar" required min="0.01">
                            </div>
                            <div class="form-group">
                                <label for="vencimento-conta-pagar">Data de Vencimento</label>
                                <input type="date" id="vencimento-conta-pagar" required>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn-submit" id="btn-salvar-conta-pagar">Registrar</button>
                            <button type="button" class="btn btn-secondary" id="btn-cancelar-conta-pagar" style="display:none;">Cancelar Edição</button>
                        </div>
                    </form>
                </div>
                <div class="card">
                    <h2>Contas a Pagar</h2>
                    <div class="table-controls">
                        <div class="form-group flex-1">
                            <label for="search-contas-pagar">Buscar</label>
                            <input type="text" id="search-contas-pagar" placeholder="Buscar por descrição...">
                        </div>
                        <div class="form-group">
                            <label for="filter-contas-pagar-status">Status</label>
                            <select id="filter-contas-pagar-status">
                                <option value="">Todos</option>
                                <option value="Pendente">Pendente</option>
                                <option value="Pago">Pago</option>
                            </select>
                        </div>
                    </div>
                    <div id="tabela-contas-pagar-container" class="table-responsive-container"></div>
                    <div id="pagination-contas-pagar" class="pagination-controls"></div>
                </div>
            </section>
            
            <section id="relatorios-view" class="content-section">
                <div class="card">
                    <h2>Gerar Relatório de Vendas</h2>
                    <div class="flex gap-2 align-items-end">
                        <div class="form-group flex-1">
                            <label for="relatorio-inicio">Data Início</label>
                            <input type="date" id="relatorio-inicio">
                        </div>
                        <div class="form-group flex-1">
                            <label for="relatorio-fim">Data Fim</label>
                            <input type="date" id="relatorio-fim">
                        </div>
                        <button id="btn-gerar-relatorio" class="btn">Gerar Relatório</button>
                    </div>
                </div>
                <div id="relatorio-container" class="card mt-3 hidden">
                    <h2>Resultados do Relatório de Vendas</h2>
                    <p>Período: <span id="relatorio-periodo"></span></p>
                    <p>Total de Vendas: <span id="relatorio-total-vendas">R$ 0,00</span></p>
                    <p>Total de Itens Vendidos: <span id="relatorio-total-itens">0</span></p>
                    <h3 style="margin-top:1.5rem;">Vendas por Método de Pagamento:</h3>
                    <ul id="relatorio-metodo-pagamento"></ul>
                    <h3 style="margin-top:1.5rem;">Produtos Mais Vendidos:</h3>
                    <ul id="relatorio-produtos-mais-vendidos"></ul>
                    <button id="btn-export-relatorio" class="btn" style="margin-top: 20px;">Exportar para CSV</button>
                </div>
            </section>

            <section id="configuracoes-view" class="content-section">
                <div class="settings-grid">
                    <div class="settings-card">
                        <h3>Backup e Restauração</h3>
                        <button id="btn-backup-data" class="btn">Fazer Backup</button>
                        <hr class="mt-3 mb-2" style="border-color: var(--border-color);">
                        <label for="backup-file-input" class="form-group">Restaurar de Backup:</label>
                        <input type="file" id="backup-file-input" accept=".json">
                        <button id="btn-restore-data" class="btn btn-secondary mt-3">Restaurar Backup</button>
                    </div>
                    <div class="settings-card">
                        <h3>Tema da Interface</h3>
                        <div class="theme-toggle-container">
                            <span>Modo Escuro</span>
                            <label class="theme-switch">
                                <input type="checkbox" id="theme-toggle-switch">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="venda-detalhes-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Detalhes da Venda</h2>
            <p><strong>ID da Venda:</strong> <span id="modal-venda-id"></span></p>
            <p><strong>Cliente:</strong> <span id="modal-venda-cliente"></span></p>
            <p><strong>Data da Venda:</strong> <span id="modal-venda-data"></span></p>
            <p><strong>Método de Pagamento:</strong> <span id="modal-venda-metodo-pagamento"></span></p>
            
            <h3 style="margin-top: 20px; margin-bottom: 10px;">Itens da Venda:</h3>
            <div class="table-responsive-container">
                <table id="modal-venda-itens-tabela">
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th>Qtd</th>
                            <th>Preço Unit.</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
            <p class="modal-total">Total da Venda: <span id="modal-venda-total">R$ 0,00</span></p>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- SELETORES GERAIS ---
        const loginScreen = document.getElementById('login-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const mainContent = document.getElementById('main-content');
        const sidebar = document.getElementById('sidebar');
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const navLinks = document.querySelectorAll('.nav-link');
        const contentSections = document.querySelectorAll('.content-section');
        const menuToggle = document.getElementById('menu-toggle');
        const mobilePageTitle = document.getElementById('mobile-page-title');
        const desktopPageTitle = document.getElementById('desktop-page-title');

        // --- ESTADO DA APLICAÇÃO ---
        let clientes = [], produtos = [], vendas = [], contasAReceber = [], contasAPagar = [], fluxoCaixa = [];
        let carrinhoVenda = [];
        let paymentChartInstance = null;

        // Paginação
        const itemsPerPage = 10;
        let currentPage = {
            caixa: 1,
            clientes: 1,
            produtos: 1,
            contasReceber: 1,
            contasPagar: 1
        };

        // --- FUNÇÕES DE DADOS E UTILITÁRIAS ---
        const saveData = (key, data) => localStorage.setItem(key, JSON.stringify(data));
        const loadData = (key) => JSON.parse(localStorage.getItem(key)) || [];
        const formatCurrency = (value) => (typeof value === 'number' ? value : 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            // Ensure date is treated consistently (e.g., as UTC or start of day in local timezone)
            const date = new Date(dateString + 'T00:00:00'); 
            return date.toLocaleDateString('pt-BR');
        };
        
        const showNotification = (message, isError = false) => {
            const notification = document.createElement('div');
            Object.assign(notification.style, {
                position: 'fixed', bottom: '20px', right: '20px', padding: '15px 25px', borderRadius: '8px',
                color: 'white', zIndex: '2000', opacity: '0', transition: 'all 0.4s ease',
                transform: 'translateY(10px)', boxShadow: '0 10px 15px -3px rgba(0,0,0,0.1)',
                backgroundColor: isError ? 'var(--danger-color)' : 'var(--success-color)', fontWeight: '500'
            });
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => { notification.style.opacity = '1'; notification.style.transform = 'translateY(0)'; }, 10);
            setTimeout(() => { notification.style.opacity = '0'; notification.style.transform = 'translateY(10px)'; setTimeout(() => notification.remove(), 500); }, 3500);
        };

        // --- FUNÇÕES DE RENDERIZAÇÃO DE TABELAS COM PAGINAÇÃO E FILTROS ---
        const renderTable = (containerId, headers, data, renderRow, page = 1, searchQuery = '', filterValue = '') => {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Apply filters first
            let filteredData = [...data]; // Create a shallow copy to avoid modifying original array
            
            // Common search for description/name
            if (searchQuery) {
                const searchLower = searchQuery.toLowerCase();
                if (['tabela-caixa-container', 'tabela-contas-pagar-container'].includes(containerId)) {
                    filteredData = filteredData.filter(item => item.descricao.toLowerCase().includes(searchLower));
                } else if (containerId === 'tabela-clientes-container') {
                    filteredData = filteredData.filter(item => 
                        item.nome.toLowerCase().includes(searchLower) || 
                        (item.contato && item.contato.toLowerCase().includes(searchLower))
                    );
                } else if (containerId === 'tabela-produtos-container') {
                    filteredData = filteredData.filter(item => item.nome.toLowerCase().includes(searchLower));
                } else if (containerId === 'tabela-contas-container') {
                    filteredData = filteredData.filter(item => {
                        const clienteNome = clientes.find(c => c.id === item.clienteId)?.nome || 'Cliente avulso';
                        return clienteNome.toLowerCase().includes(searchLower);
                    });
                }
            }

            // Specific filters
            if (containerId === 'tabela-caixa-container' && filterValue) {
                filteredData = filteredData.filter(item => item.tipo === filterValue);
            } else if (containerId === 'tabela-clientes-container' && filterValue) {
                // No specific filter for clientes beyond search
            } else if (containerId === 'tabela-produtos-container' && filterValue) {
                if (filterValue === 'low') {
                    filteredData = filteredData.filter(item => item.quantidade > 0 && item.quantidade < 10);
                } else if (filterValue === 'empty') {
                    filteredData = filteredData.filter(item => item.quantidade === 0);
                }
            } else if (['tabela-contas-container', 'tabela-contas-pagar-container'].includes(containerId) && filterValue) {
                filteredData = filteredData.filter(item => item.status === filterValue);
            }

            // Pagination logic
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedData = filteredData.slice(start, end);

            container.innerHTML = ''; // Clear previous content
            if (paginatedData.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding: 20px; color: var(--text-secondary);">Nenhum registro encontrado.</p>';
            } else {
                const table = document.createElement('table');
                table.innerHTML = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${paginatedData.map(renderRow).join('')}</tbody>`;
                container.appendChild(table);
            }
            
            renderPagination(containerId.replace('tabela-', 'pagination-'), totalPages, page, searchQuery, filterValue);
        };

        const renderPagination = (paginationContainerId, totalPages, currentPage, searchQuery, filterValue) => {
            const paginationContainer = document.getElementById(paginationContainerId);
            if (!paginationContainer) return;

            paginationContainer.innerHTML = ''; // Clear previous content

            if (totalPages <= 1) {
                return; // No pagination needed for 1 or less pages
            }

            const prevButton = document.createElement('button');
            prevButton.textContent = 'Anterior';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                goToPage(paginationContainerId.replace('pagination-', ''), currentPage - 1, searchQuery, filterValue);
            });
            paginationContainer.appendChild(prevButton);

            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
            paginationContainer.appendChild(pageInfo);

            const nextButton = document.createElement('button');
            nextButton.textContent = 'Próxima';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => {
                goToPage(paginationContainerId.replace('pagination-', ''), currentPage + 1, searchQuery, filterValue);
            });
            paginationContainer.appendChild(nextButton);
        };

        const goToPage = (sectionId, pageNumber, searchQuery = '', filterValue = '') => {
            currentPage[sectionId] = pageNumber;
            // Re-render the specific section
            if (sectionId === 'caixa') renderFluxoCaixa(searchQuery, filterValue);
            else if (sectionId === 'clientes') renderClientes(searchQuery);
            else if (sectionId === 'produtos') renderProdutos(searchQuery, filterValue);
            else if (sectionId === 'contas-receber') renderContasAReceber(searchQuery, filterValue);
            else if (sectionId === 'contas-pagar') renderContasAPagar(searchQuery, filterValue);
        };

        const navigateToPage = (pageId) => {
            if (!pageId || !document.getElementById(pageId)) {
                pageId = 'dashboard-view'; // Default to dashboard
            }
            
            contentSections.forEach(s => s.classList.remove('active'));
            navLinks.forEach(l => l.classList.remove('active'));

            document.getElementById(pageId).classList.add('active');
            const targetLink = document.querySelector(`.nav-link[data-target="${pageId}"]`);
            if (targetLink) {
                targetLink.classList.add('active');
                const pageName = targetLink.querySelector('span').textContent;
                desktopPageTitle.textContent = pageName;
                mobilePageTitle.textContent = pageName;
            }

            localStorage.setItem('lastActivePage', pageId);

            // Calls the specific rendering function for the activated page
            if (pageId === 'dashboard-view') renderDashboardSummaries();
            if (pageId === 'caixa-view') renderFluxoCaixa();
            if (pageId === 'vendas-view') { popularFormulariosVenda(); renderCarrinho(); }
            if (pageId === 'clientes-view') renderClientes();
            if (pageId === 'estoque-view') { renderProdutos(); populateUpdateStockProductSelect(); }
            if (pageId === 'contas-a-receber-view') renderContasAReceber();
            if (pageId === 'contas-a-pagar-view') renderContasAPagar();
            if (pageId === 'relatorios-view') document.getElementById('relatorio-container').classList.add('hidden'); // Hide report results on page load
        };
        
        const renderDashboardSummaries = () => {
            const saldoCaixaEl = document.getElementById('saldo-caixa-dashboard');
            if (!saldoCaixaEl) return; 

            saldoCaixaEl.textContent = formatCurrency(fluxoCaixa.reduce((acc, item) => acc + (item.tipo === 'Entrada' ? item.valor : -item.valor), 0));
            document.getElementById('total-a-receber-dashboard').textContent = formatCurrency(contasAReceber.filter(c => c.status === 'Pendente').reduce((acc, c) => acc + c.valor, 0));
            document.getElementById('total-a-pagar-dashboard').textContent = formatCurrency(contasAPagar.filter(c => c.status === 'Pendente').reduce((acc, c) => acc + c.valor, 0));


            const salesSummary = vendas.reduce((acc, venda) => {
                acc[venda.metodoPagamento] = (acc[venda.metodoPagamento] || 0) + venda.total;
                return acc;
            }, { vista: 0, pix: 0, fiado: 0, parcelado: 0 });

            const summaryContainer = document.getElementById('sales-summary-container');
            if (summaryContainer) {
                summaryContainer.innerHTML = `
                    <div class="summary-card" style="border-left: 4px solid var(--success-color); margin-bottom: 1rem;"><h3 style="font-weight:500; color:var(--text-secondary);">À Vista</h3><p>${formatCurrency(salesSummary.vista)}</p></div>
                    <div class="summary-card" style="border-left: 4px solid var(--info-color); margin-bottom: 1rem;"><h3 style="font-weight:500; color:var(--text-secondary);">Pix</h3><p>${formatCurrency(salesSummary.pix)}</p></div>
                    <div class="summary-card" style="border-left: 4px solid var(--warning-color); margin-bottom: 1rem;"><h3 style="font-weight:500; color:var(--text-secondary);">Fiado</h3><p>${formatCurrency(salesSummary.fiado)}</p></div>
                    <div class="summary-card" style="border-left: 4px solid var(--danger-color);"><h3 style="font-weight:500; color:var(--text-secondary);">Parcelado</h3><p>${formatCurrency(salesSummary.parcelado)}</p></div>
                `;
            }
            renderPaymentChart(salesSummary);
        };
        
        const renderPaymentChart = (salesSummary) => {
            const ctx = document.getElementById('paymentMethodChart');
            if (!ctx) return; 

            if(paymentChartInstance) paymentChartInstance.destroy();

            paymentChartInstance = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['À Vista', 'Pix', 'Fiado', 'Parcelado'],
                    datasets: [{
                        label: 'Total de Vendas',
                        data: [ salesSummary.vista, salesSummary.pix, salesSummary.fiado, salesSummary.parcelado ],
                        backgroundColor: [ 'var(--success-color)', 'var(--info-color)', 'var(--warning-color)', 'var(--danger-color)' ],
                        borderColor: [ 'var(--success-color)', 'var(--info-color)', 'var(--warning-color)', 'var(--danger-color)' ],
                        borderWidth: 1, borderRadius: 4,
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `${c.label}: ${formatCurrency(c.raw)}` } } },
                    scales: { 
                        x: { 
                            beginAtZero: true, 
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { color: 'var(--text-secondary)' }
                        }, 
                        y: { 
                            grid: { display: false },
                            ticks: { color: 'var(--text-secondary)' }
                        } 
                    }
                }
            });
        };

        const renderFluxoCaixa = (searchQuery = '', filterValue = '') => {
            const saldoEl = document.getElementById('saldo-caixa-detalhe');
            if (!saldoEl) return;
            saldoEl.textContent = formatCurrency(fluxoCaixa.reduce((acc, item) => acc + (item.tipo === 'Entrada' ? item.valor : -item.valor), 0));
            
            const sortedData = fluxoCaixa.sort((a,b) => new Date(b.data) - new Date(a.data));
            renderTable('tabela-caixa-container', ['Data', 'Descrição', 'Tipo', 'Valor', 'Ações'], sortedData, item => `
                <tr>
                    <td>${formatDate(item.data)}</td>
                    <td>${item.descricao}</td>
                    <td><span class="valor-${item.tipo.toLowerCase()}">${item.tipo}</span></td>
                    <td><span class="valor-${item.tipo.toLowerCase()}">${item.tipo === 'Entrada' ? '+' : '-'} ${formatCurrency(item.valor)}</span></td>
                    <td>
                        <button class="btn-action btn-edit" data-id="${item.id}" data-type="lancamento">Editar</button>
                        <button class="btn-action btn-delete" data-id="${item.id}" data-type="lancamento">Excluir</button>
                    </td>
                </tr>`, currentPage.caixa, searchQuery, filterValue);
                resetForm('form-add-lancamento', 'lancamento');
        };

        const renderClientes = (searchQuery = '') => {
            const sortedData = clientes.sort((a,b) => a.nome.localeCompare(b.nome));
            renderTable('tabela-clientes-container', ['Nome', 'Contato', 'Ações'], sortedData, c => `
                <tr>
                    <td>${c.nome}</td>
                    <td>${c.contato || 'N/A'}</td>
                    <td>
                        <button class="btn-action btn-edit" data-id="${c.id}" data-type="cliente">Editar</button>
                        <button class="btn-action btn-delete" data-id="${c.id}" data-type="cliente">Excluir</button>
                    </td>
                </tr>`, currentPage.clientes, searchQuery);
            resetForm('form-add-cliente', 'cliente');
        }

        const renderProdutos = (searchQuery = '', filterValue = '') => {
            const sortedData = produtos.sort((a,b) => a.nome.localeCompare(b.nome));
            renderTable('tabela-produtos-container', ['Produto', 'Qtd. em Estoque', 'Preço', 'Ações'], sortedData, p => `
                <tr>
                    <td>${p.nome}</td>
                    <td>${p.quantidade}</td>
                    <td>${formatCurrency(p.preco)}</td>
                    <td>
                        <button class="btn-action btn-edit" data-id="${p.id}" data-type="produto">Editar</button>
                        <button class="btn-action btn-delete" data-id="${p.id}" data-type="produto">Excluir</button>
                    </td>
                </tr>`, currentPage.produtos, searchQuery, filterValue);
            resetForm('form-add-produto', 'produto');
        };

        const renderContasAReceber = (searchQuery = '', filterValue = '') => {
            const getNomeCliente = id => clientes.find(c => c.id === id)?.nome || 'Cliente avulso';
            const sortedData = contasAReceber.sort((a,b) => new Date(a.dataVencimento) - new Date(b.dataVencimento));
            renderTable('tabela-contas-container', ['Cliente', 'Valor', 'Vencimento', 'Status', 'Ação'], sortedData, conta => `
                <tr>
                    <td>${getNomeCliente(conta.clienteId)}</td>
                    <td>${formatCurrency(conta.valor)}</td>
                    <td>${formatDate(conta.dataVencimento)}</td>
                    <td><span class="status-${conta.status.toLowerCase()}">${conta.status}</span></td>
                    <td>
                        ${conta.status === 'Pendente' ? `<button class="btn-action btn-paid" data-id="${conta.id}">Dar Baixa</button>` : 'Recebido'}
                        <button class="btn-action btn-info" data-id="${conta.vendaId}" data-type="venda-detalhes">Ver Venda</button>
                    </td>
                </tr>`, currentPage.contasReceber, searchQuery, filterValue);
        };

        const renderContasAPagar = (searchQuery = '', filterValue = '') => {
            const sortedData = contasAPagar.sort((a,b) => new Date(a.dataVencimento) - new Date(b.dataVencimento));
            renderTable('tabela-contas-pagar-container', ['Descrição', 'Valor', 'Vencimento', 'Status', 'Ação'], sortedData, conta => `
                <tr>
                    <td>${conta.descricao}</td>
                    <td>${formatCurrency(conta.valor)}</td>
                    <td>${formatDate(conta.dataVencimento)}</td>
                    <td><span class="status-${conta.status.toLowerCase()}">${conta.status}</span></td>
                    <td>
                        ${conta.status === 'Pendente' ? `<button class="btn-action btn-paid" data-id="${conta.id}" data-type="conta-pagar">Dar Baixa</button>` : 'Pago'}
                        <button class="btn-action btn-edit" data-id="${conta.id}" data-type="conta-pagar">Editar</button>
                        <button class="btn-action btn-delete" data-id="${conta.id}" data-type="conta-pagar">Excluir</button>
                    </td>
                </tr>`, currentPage.contasPagar, searchQuery, filterValue);
                resetForm('form-add-conta-pagar', 'conta-pagar');
        };

        const popularFormulariosVenda = () => {
            const clienteSelect = document.getElementById('venda-cliente');
            const produtoSelect = document.getElementById('venda-produto');

            if(clienteSelect) {
                clienteSelect.innerHTML = '<option value="">Selecione...</option>' + clientes.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
            }
            if(produtoSelect) {
                produtoSelect.innerHTML = '<option value="">Selecione...</option>' + produtos.filter(p => p.quantidade > 0).map(p => `<option value="${p.id}">${p.nome} (${p.quantidade} disp.)</option>`).join('');
            }
        };

        const populateUpdateStockProductSelect = () => {
            const updateStockProductSelect = document.getElementById('update-stock-product');
            if (updateStockProductSelect) {
                updateStockProductSelect.innerHTML = '<option value="">Selecione...</option>' + produtos.map(p => `<option value="${p.id}">${p.nome} (Estoque: ${p.quantidade})</option>`).join('');
            }
        };

        const renderCarrinho = () => {
            const totalEl = document.getElementById('venda-total');
            if (!totalEl) return;
            renderTable('venda-itens-container', ['Produto', 'Qtd', 'Subtotal', 'Ação'], carrinhoVenda, item => `
                <tr>
                    <td>${item.nome}</td>
                    <td>${item.quantidade}</td>
                    <td>${formatCurrency(item.subtotal)}</td>
                    <td><button class="btn-action btn-delete" data-id="${item.produtoId}" data-type="carrinho">Remover</button></td>
                </tr>`);
            totalEl.textContent = formatCurrency(carrinhoVenda.reduce((acc, item) => acc + item.subtotal, 0));
        };
        
        const addItemAoCarrinho = () => {
            const produtoId = document.getElementById('venda-produto').value;
            const quantidadeInput = document.getElementById('venda-qtd');
            const quantidade = parseInt(quantidadeInput.value);

            if (!produtoId || isNaN(quantidade) || quantidade <= 0) { 
                showNotification('Selecione um produto e uma quantidade válida.', true); 
                return; 
            }
            const produto = produtos.find(p => p.id == produtoId);
            if (!produto) { showNotification('Produto não encontrado.', true); return; }

            const itemExistente = carrinhoVenda.find(item => item.produtoId == produtoId);
            const qtdNoCarrinho = itemExistente ? itemExistente.quantidade : 0;

            if (quantidade + qtdNoCarrinho > produto.quantidade) { 
                showNotification(`Quantidade insuficiente em estoque! Disponível: ${produto.quantidade - qtdNoCarrinho}`, true); 
                return; 
            }

            if (itemExistente) {
                itemExistente.quantidade += quantidade;
                itemExistente.subtotal = parseFloat((itemExistente.quantidade * produto.preco).toFixed(2));
            } else {
                carrinhoVenda.push({ produtoId: produto.id, nome: produto.nome, quantidade, precoUnitario: produto.preco, subtotal: parseFloat((quantidade * produto.preco).toFixed(2)) });
            }
            renderCarrinho();
            showNotification('Item adicionado ao carrinho.');
            quantidadeInput.value = 1; // Reset quantity input
        };

        const finalizarVenda = () => {
            const clienteId = document.getElementById('venda-cliente').value;
            if (!clienteId || carrinhoVenda.length === 0) { showNotification('Selecione um cliente e adicione itens!', true); return; }
            
            const total = parseFloat(carrinhoVenda.reduce((acc, item) => acc + item.subtotal, 0).toFixed(2));
            const metodoPagamento = document.getElementById('venda-pagamento').value;
            
            const novaVenda = { 
                id: Date.now(), 
                clienteId: parseInt(clienteId), 
                itens: [...carrinhoVenda], 
                total, 
                metodoPagamento, 
                data: new Date().toISOString().split('T')[0] 
            };
            
            vendas.push(novaVenda);
            
            carrinhoVenda.forEach(item => {
                const produtoEstoque = produtos.find(p => p.id == item.produtoId);
                if(produtoEstoque) produtoEstoque.quantidade -= item.quantidade;
            });
            
            if (metodoPagamento === 'vista' || metodoPagamento === 'pix') {
                const clienteNome = clientes.find(c => c.id === novaVenda.clienteId)?.nome || 'Avulso';
                fluxoCaixa.push({ id: Date.now(), data: new Date().toISOString().split('T')[0], tipo: 'Entrada', descricao: `Venda (${metodoPagamento}) para ${clienteNome} (Venda #${novaVenda.id})`, valor: novaVenda.total });
            } else if (metodoPagamento === 'fiado' || metodoPagamento === 'parcelado') {
                const parcelas = metodoPagamento === 'fiado' ? 1 : parseInt(document.getElementById('venda-parcelas').value);
                const valorParcela = parseFloat((total / parcelas).toFixed(2));
                for (let i = 1; i <= parcelas; i++) {
                    const dataVencimento = new Date();
                    dataVencimento.setMonth(dataVencimento.getMonth() + i);
                    contasAReceber.push({ 
                        id: Date.now() + i, 
                        vendaId: novaVenda.id, 
                        clienteId: novaVenda.clienteId, 
                        valor: valorParcela, 
                        dataVencimento: dataVencimento.toISOString().split('T')[0], 
                        status: 'Pendente' 
                    });
                }
            }
            
            saveData('vendas', vendas); 
            saveData('produtos', produtos); 
            saveData('contasAReceber', contasAReceber); 
            saveData('fluxoCaixa', fluxoCaixa);
            
            showNotification('Venda realizada com sucesso!');
            carrinhoVenda = []; 
            document.getElementById('venda-form').reset();
            document.getElementById('venda-parcelas-group').classList.add('hidden');
            renderCarrinho();
            popularFormulariosVenda();
            populateUpdateStockProductSelect(); // Update stock view after sale
            renderDashboardSummaries(); // Update dashboard after sale
        };

        // --- CRUD HELPER FUNCTIONS ---
        const resetForm = (formId, type) => {
            document.getElementById(formId).reset();
            let idField, submitBtn, cancelBtn;

            if (type === 'cliente') {
                idField = document.getElementById('cliente-id');
                submitBtn = document.getElementById('btn-salvar-cliente');
                cancelBtn = document.getElementById('btn-cancelar-cliente');
            } else if (type === 'produto') {
                idField = document.getElementById('produto-id');
                submitBtn = document.getElementById('btn-salvar-produto');
                cancelBtn = document.getElementById('btn-cancelar-produto');
            } else if (type === 'lancamento') {
                idField = document.getElementById('lancamento-id');
                submitBtn = document.getElementById('btn-salvar-lancamento');
                cancelBtn = document.getElementById('btn-cancelar-lancamento');
            } else if (type === 'conta-pagar') {
                idField = document.getElementById('conta-pagar-id');
                submitBtn = document.getElementById('btn-salvar-conta-pagar');
                cancelBtn = document.getElementById('btn-cancelar-conta-pagar');
            }

            if (idField) idField.value = '';
            if (submitBtn) {
                 if (type === 'cliente') submitBtn.textContent = 'Salvar Cliente';
                 else if (type === 'produto') submitBtn.textContent = 'Adicionar/Atualizar Produto';
                 else if (type === 'lancamento') submitBtn.textContent = 'Lançar';
                 else if (type === 'conta-pagar') submitBtn.textContent = 'Registrar';
            }
            if (cancelBtn) cancelBtn.style.display = 'none';
        };


        const deleteItem = (id, type) => {
            if (!confirm(`Tem certeza que deseja excluir este ${type}?`)) return;

            let dataArray;
            let saveDataKey;
            let renderFunction;

            switch (type) {
                case 'cliente':
                    dataArray = clientes;
                    saveDataKey = 'clientes';
                    renderFunction = renderClientes;
                    if (vendas.some(v => v.clienteId === id) || contasAReceber.some(c => c.clienteId === id)) {
                        showNotification('Não é possível excluir cliente com vendas ou contas associadas.', true);
                        return;
                    }
                    break;
                case 'produto':
                    dataArray = produtos;
                    saveDataKey = 'produtos';
                    renderFunction = renderProdutos;
                    if (vendas.some(v => v.itens.some(item => item.produtoId === id))) {
                        showNotification('Não é possível excluir produto já presente em vendas.', true);
                        return;
                    }
                    break;
                case 'lancamento':
                    dataArray = fluxoCaixa;
                    saveDataKey = 'fluxoCaixa';
                    renderFunction = renderFluxoCaixa;
                    break;
                case 'conta-pagar':
                    dataArray = contasAPagar;
                    saveDataKey = 'contasAPagar';
                    renderFunction = renderContasAPagar;
                    break;
                default:
                    showNotification('Tipo de item desconhecido para exclusão.', true);
                    return;
            }

            const initialLength = dataArray.length;
            // Generalize filtering based on the array and ID
            if (type === 'cliente') clientes = clientes.filter(item => item.id !== id);
            else if (type === 'produto') produtos = produtos.filter(item => item.id !== id);
            else if (type === 'lancamento') fluxoCaixa = fluxoCaixa.filter(item => item.id !== id);
            else if (type === 'conta-pagar') contasAPagar = contasAPagar.filter(item => item.id !== id);
            
            if (dataArray.length > (type === 'cliente' ? clientes.length : type === 'produto' ? produtos.length : type === 'lancamento' ? fluxoCaixa.length : contasAPagar.length) ) { // Check if an item was actually removed
                saveData(saveDataKey, type === 'cliente' ? clientes : type === 'produto' ? produtos : type === 'lancamento' ? fluxoCaixa : contasAPagar);
                showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} excluído(a) com sucesso!`);
                renderFunction();
                // Special updates for product/client related changes
                if (type === 'produto') { popularFormulariosVenda(); populateUpdateStockProductSelect(); }
                if (type === 'cliente') { popularFormulariosVenda(); }
                renderDashboardSummaries(); // Refresh dashboard on relevant changes
            } else {
                showNotification(`Não foi possível encontrar o ${type} para exclusão.`, true);
            }
        };

        const editItem = (id, type) => {
            let itemToEdit;
            let idField, submitBtn, cancelBtn;

            if (type === 'cliente') {
                itemToEdit = clientes.find(c => c.id === id);
                idField = document.getElementById('cliente-id');
                submitBtn = document.getElementById('btn-salvar-cliente');
                cancelBtn = document.getElementById('btn-cancelar-cliente');
                if (itemToEdit) {
                    idField.value = itemToEdit.id;
                    document.getElementById('nome-cliente').value = itemToEdit.nome;
                    document.getElementById('contato-cliente').value = itemToEdit.contato;
                    submitBtn.textContent = 'Atualizar Cliente';
                    cancelBtn.style.display = 'inline-block';
                    showNotification('Formulário preenchido para edição de cliente.');
                }
            } else if (type === 'produto') {
                itemToEdit = produtos.find(p => p.id === id);
                idField = document.getElementById('produto-id');
                submitBtn = document.getElementById('btn-salvar-produto');
                cancelBtn = document.getElementById('btn-cancelar-produto');
                if (itemToEdit) {
                    idField.value = itemToEdit.id;
                    document.getElementById('nome-produto').value = itemToEdit.nome;
                    document.getElementById('qtd-produto').value = itemToEdit.quantidade;
                    document.getElementById('preco-produto').value = itemToEdit.preco;
                    submitBtn.textContent = 'Atualizar Produto';
                    cancelBtn.style.display = 'inline-block';
                    showNotification('Formulário preenchido para edição de produto.');
                }
            } else if (type === 'lancamento') {
                itemToEdit = fluxoCaixa.find(l => l.id === id);
                idField = document.getElementById('lancamento-id');
                submitBtn = document.getElementById('btn-salvar-lancamento');
                cancelBtn = document.getElementById('btn-cancelar-lancamento');
                if (itemToEdit) {
                    idField.value = itemToEdit.id;
                    document.getElementById('desc-lancamento').value = itemToEdit.descricao;
                    document.getElementById('valor-lancamento').value = itemToEdit.valor;
                    document.getElementById('tipo-lancamento').value = itemToEdit.tipo;
                    submitBtn.textContent = 'Atualizar Lançamento';
                    cancelBtn.style.display = 'inline-block';
                    showNotification('Formulário preenchido para edição de lançamento.');
                }
            } else if (type === 'conta-pagar') {
                itemToEdit = contasAPagar.find(l => l.id === id);
                idField = document.getElementById('conta-pagar-id');
                submitBtn = document.getElementById('btn-salvar-conta-pagar');
                cancelBtn = document.getElementById('btn-cancelar-conta-pagar');
                if (itemToEdit) {
                    idField.value = itemToEdit.id;
                    document.getElementById('desc-conta-pagar').value = itemToEdit.descricao;
                    document.getElementById('valor-conta-pagar').value = itemToEdit.valor;
                    document.getElementById('vencimento-conta-pagar').value = itemToEdit.dataVencimento;
                    submitBtn.textContent = 'Atualizar Conta a Pagar';
                    cancelBtn.style.display = 'inline-block';
                    showNotification('Formulário preenchido para edição de conta a pagar.');
                }
            }
            if (!itemToEdit) {
                showNotification(`Não foi possível encontrar o ${type} para edição.`, true);
            }
        };
        
        // --- RELATORIOS ---
        document.getElementById('btn-gerar-relatorio').addEventListener('click', () => {
            const startDateStr = document.getElementById('relatorio-inicio').value;
            const endDateStr = document.getElementById('relatorio-fim').value;
            const reportContainer = document.getElementById('relatorio-container');
            
            if (!startDateStr || !endDateStr) {
                showNotification('Por favor, selecione as datas de início e fim para o relatório.', true);
                reportContainer.classList.add('hidden');
                return;
            }

            const startDate = new Date(startDateStr + 'T00:00:00');
            const endDate = new Date(endDateStr + 'T23:59:59'); // Include full end day

            if (startDate > endDate) {
                showNotification('A data de início não pode ser posterior à data de fim.', true);
                reportContainer.classList.add('hidden');
                return;
            }

            const filteredSales = vendas.filter(sale => {
                const saleDate = new Date(sale.data + 'T00:00:00');
                return saleDate >= startDate && saleDate <= endDate;
            });

            let totalSalesAmount = 0;
            let totalItemsSold = 0;
            const salesByPaymentMethod = {};
            const productsSoldQuantities = {};

            filteredSales.forEach(sale => {
                totalSalesAmount += sale.total;
                sale.itens.forEach(item => {
                    totalItemsSold += item.quantidade;
                    productsSoldQuantities[item.nome] = (productsSoldQuantities[item.nome] || 0) + item.quantidade;
                });
                salesByPaymentMethod[sale.metodoPagamento] = (salesByPaymentMethod[sale.metodoPagamento] || 0) + sale.total;
            });

            document.getElementById('relatorio-periodo').textContent = `${formatDate(startDateStr)} a ${formatDate(endDateStr)}`;
            document.getElementById('relatorio-total-vendas').textContent = formatCurrency(totalSalesAmount);
            document.getElementById('relatorio-total-itens').textContent = totalItemsSold;

            const paymentMethodList = document.getElementById('relatorio-metodo-pagamento');
            paymentMethodList.innerHTML = '';
            for (const method in salesByPaymentMethod) {
                let methodName = '';
                switch(method) {
                    case 'vista': methodName = 'À Vista'; break;
                    case 'pix': methodName = 'Pix'; break;
                    case 'fiado': methodName = 'Fiado'; break;
                    case 'parcelado': methodName = 'Parcelado'; break;
                    default: methodName = method;
                }
                const listItem = document.createElement('li');
                listItem.textContent = `${methodName}: ${formatCurrency(salesByPaymentMethod[method])}`;
                paymentMethodList.appendChild(listItem);
            }

            const productsSoldList = document.getElementById('relatorio-produtos-mais-vendidos');
            productsSoldList.innerHTML = '';
            const sortedProducts = Object.entries(productsSoldQuantities).sort(([, a], [, b]) => b - a);
            if (sortedProducts.length === 0) {
                productsSoldList.innerHTML = '<li>Nenhum produto vendido neste período.</li>';
            } else {
                sortedProducts.forEach(([productName, quantity]) => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${productName}: ${quantity} unidades`;
                    productsSoldList.appendChild(listItem);
                });
            }

            reportContainer.classList.remove('hidden');
            showNotification('Relatório gerado com sucesso!');
        });

        document.getElementById('btn-export-relatorio').addEventListener('click', () => {
            const startDateStr = document.getElementById('relatorio-inicio').value;
            const endDateStr = document.getElementById('relatorio-fim').value;
            
            if (!startDateStr || !endDateStr) {
                showNotification('Defina o período do relatório antes de exportar.', true);
                return;
            }

            const startDate = new Date(startDateStr + 'T00:00:00');
            const endDate = new Date(endDateStr + 'T23:59:59');

            const filteredSales = vendas.filter(sale => {
                const saleDate = new Date(sale.data + 'T00:00:00');
                return saleDate >= startDate && saleDate <= endDate;
            });

            if (filteredSales.length === 0) {
                showNotification('Nenhum dado para exportar neste período.', true);
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "ID Venda,Cliente,Data,Total,Metodo Pagamento,Produto,Quantidade,Preco Unitario,Subtotal\n";

            filteredSales.forEach(sale => {
                const clientName = clientes.find(c => c.id === sale.clienteId)?.nome || 'Avulso';
                sale.itens.forEach(item => {
                    csvContent += `${sale.id},"${clientName}",${formatDate(sale.data)},${sale.total.toFixed(2)},${sale.metodoPagamento},"${item.nome}",${item.quantidade},${item.precoUnitario.toFixed(2)},${item.subtotal.toFixed(2)}\n`;
                });
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `relatorio_vendas_${startDateStr}_${endDateStr}.csv`);
            document.body.appendChild(link); // Required for Firefox
            link.click();
            document.body.removeChild(link);
            showNotification('Relatório CSV exportado com sucesso!');
        });

        // --- BACKUP/RESTORE FUNCTIONS ---
        const backupData = () => {
            const data = {
                clientes: clientes,
                produtos: produtos,
                vendas: vendas,
                contasAReceber: contasAReceber,
                contasAPagar: contasAPagar, // Include Contas a Pagar
                fluxoCaixa: fluxoCaixa,
                // Store theme setting
                theme: document.body.classList.contains('dark-theme') ? 'dark' : 'light'
            };
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `flordemaira_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('Backup realizado com sucesso!');
        };

        const restoreData = (event) => {
            const file = event.target.files[0];
            if (!file) {
                showNotification('Nenhum arquivo selecionado.', true);
                return;
            }

            if (!confirm('Tem certeza que deseja restaurar o backup? Isso substituirá TODOS os dados atuais do sistema!')) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const restoredData = JSON.parse(e.target.result);
                    
                    // Clear existing data (optional, but safer for full restore)
                    localStorage.clear();

                    // Restore data to arrays and localStorage
                    clientes = restoredData.clientes || [];
                    produtos = restoredData.produtos || [];
                    vendas = restoredData.vendas || [];
                    contasAReceber = restoredData.contasAReceber || [];
                    contasAPagar = restoredData.contasAPagar || []; // Restore Contas a Pagar
                    fluxoCaixa = restoredData.fluxoCaixa || [];
                    
                    saveData('clientes', clientes);
                    saveData('produtos', produtos);
                    saveData('vendas', vendas);
                    saveData('contasAReceber', contasAReceber);
                    saveData('contasAPagar', contasAPagar);
                    saveData('fluxoCaixa', fluxoCaixa);

                    // Restore theme preference
                    const restoredTheme = restoredData.theme || 'light';
                    localStorage.setItem('theme', restoredTheme);
                    applyTheme(restoredTheme);
                    document.getElementById('theme-toggle-switch').checked = (restoredTheme === 'dark');

                    showNotification('Backup restaurado com sucesso! Recarregando o sistema...');
                    setTimeout(() => {
                        // Reinitialize the app to reflect restored data
                        window.location.reload(); 
                    }, 1000);

                } catch (error) {
                    console.error('Erro ao restaurar backup:', error);
                    showNotification('Erro ao processar o arquivo de backup. Verifique se é um JSON válido.', true);
                }
            };
            reader.readAsText(file);
        };

        // --- THEME TOGGLE ---
        const applyTheme = (theme) => {
            document.body.classList.toggle('dark-theme', theme === 'dark');
        };

        // --- MODAL DETALHES DA VENDA ---
        const vendaDetalhesModal = document.getElementById('venda-detalhes-modal');
        const closeModalButton = vendaDetalhesModal.querySelector('.close-button');

        closeModalButton.addEventListener('click', () => {
            vendaDetalhesModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target == vendaDetalhesModal) {
                vendaDetalhesModal.style.display = 'none';
            }
        });

        const showVendaDetalhesModal = (vendaId) => {
            const venda = vendas.find(v => v.id === vendaId);
            if (!venda) {
                showNotification('Venda não encontrada.', true);
                return;
            }

            document.getElementById('modal-venda-id').textContent = venda.id;
            document.getElementById('modal-venda-cliente').textContent = clientes.find(c => c.id === venda.clienteId)?.nome || 'Cliente avulso';
            document.getElementById('modal-venda-data').textContent = formatDate(venda.data);
            
            let metodoNome = '';
            switch(venda.metodoPagamento) {
                case 'vista': metodoNome = 'À Vista'; break;
                case 'pix': metodoNome = 'Pix'; break;
                case 'fiado': metodoNome = 'Fiado'; break;
                case 'parcelado': metodoNome = `Parcelado (${contasAReceber.filter(c => c.vendaId === venda.id).length}x)`; break;
                default: metodoNome = venda.metodoPagamento;
            }
            document.getElementById('modal-venda-metodo-pagamento').textContent = metodoNome;
            document.getElementById('modal-venda-total').textContent = formatCurrency(venda.total);

            const itensTableBody = vendaDetalhesModal.querySelector('#modal-venda-itens-tabela tbody');
            itensTableBody.innerHTML = ''; // Clear previous items

            if (venda.itens && venda.itens.length > 0) {
                venda.itens.forEach(item => {
                    const row = itensTableBody.insertRow();
                    row.innerHTML = `
                        <td>${item.nome}</td>
                        <td>${item.quantidade}</td>
                        <td>${formatCurrency(item.precoUnitario)}</td>
                        <td>${formatCurrency(item.subtotal)}</td>
                    `;
                });
            } else {
                itensTableBody.innerHTML = '<tr><td colspan="4" class="text-center" style="color:var(--text-secondary);">Nenhum item registrado para esta venda.</td></tr>';
            }

            vendaDetalhesModal.style.display = 'flex'; // Show the modal
        };


        // --- INICIALIZAÇÃO ---
        const init = () => {
            clientes = loadData('clientes');
            produtos = loadData('produtos');
            vendas = loadData('vendas');
            contasAReceber = loadData('contasAReceber');
            contasAPagar = loadData('contasAPagar');
            fluxoCaixa = loadData('fluxoCaixa');
            
            // Set initial value for a/c parcelas to 2x if it doesn't exist
            if (document.getElementById('venda-parcelas') && !document.getElementById('venda-parcelas').value) {
                document.getElementById('venda-parcelas').value = '2';
            }

            // Apply saved theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
            document.getElementById('theme-toggle-switch').checked = (savedTheme === 'dark');

            const lastPageId = localStorage.getItem('lastActivePage');
            navigateToPage(lastPageId); // Render initial page
        };
        
        // --- EVENT LISTENERS ---
        loginForm.addEventListener('submit', e => { 
            e.preventDefault(); 
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const errorMessageEl = document.getElementById('error-message');

            if (usernameInput.value === 'maira' && passwordInput.value === 'flor123') { 
                localStorage.setItem('isLoggedIn', 'true'); 
                loginScreen.classList.add('hidden'); 
                dashboardScreen.classList.remove('hidden'); 
                init(); 
                errorMessageEl.textContent = ''; // Clear error message on success
            } else { 
                errorMessageEl.textContent = 'Usuário ou senha inválidos.';
                showNotification('Falha no login. Verifique suas credenciais.', true);
                usernameInput.value = ''; 
                passwordInput.value = '';
                usernameInput.focus();
            }
        });
        
        logoutBtn.addEventListener('click', () => {
            if (paymentChartInstance) { paymentChartInstance.destroy(); paymentChartInstance = null; }
            localStorage.clear(); // Clear all local storage
            clientes = []; produtos = []; vendas = []; contasAReceber = []; contasAPagar = []; fluxoCaixa = []; carrinhoVenda = []; // Reset data arrays
            document.body.classList.remove('dark-theme'); // Reset theme
            dashboardScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            document.getElementById('username').value = ''; // Clear login fields
            document.getElementById('password').value = '';
            document.getElementById('error-message').textContent = '';
        });
        
        navLinks.forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                navigateToPage(link.getAttribute('data-target'));
                if(window.innerWidth <= 768) sidebar.classList.remove('open');
            });
        });
        
        menuToggle.addEventListener('click', (e) => { e.stopPropagation(); sidebar.classList.toggle('open'); });
        mainContent.addEventListener('click', () => { if (sidebar.classList.contains('open')) sidebar.classList.remove('open'); });
        
        // CLIENTES CRUD EVENTS
        document.getElementById('form-add-cliente').addEventListener('submit', e => { 
            e.preventDefault(); 
            const id = document.getElementById('cliente-id').value;
            const nome = document.getElementById('nome-cliente').value;
            const contato = document.getElementById('contato-cliente').value;

            if (id) { // Editing existing client
                const index = clientes.findIndex(c => c.id == id);
                if (index !== -1) {
                    clientes[index] = { ...clientes[index], nome, contato };
                    showNotification('Cliente atualizado!');
                }
            } else { // Adding new client
                clientes.push({ id: Date.now(), nome, contato }); 
                showNotification('Cliente salvo!'); 
            }
            saveData('clientes', clientes); 
            renderClientes(); 
            popularFormulariosVenda(); 
        });

        document.getElementById('btn-cancelar-cliente').addEventListener('click', () => resetForm('form-add-cliente', 'cliente'));

        document.getElementById('tabela-clientes-container').addEventListener('click', e => {
            const target = e.target;
            const id = parseInt(target.getAttribute('data-id'));
            const type = target.getAttribute('data-type');
            if (target.classList.contains('btn-edit') && type === 'cliente') {
                editItem(id, type);
            } else if (target.classList.contains('btn-delete') && type === 'cliente') {
                deleteItem(id, type);
            }
        });

        document.getElementById('search-clientes').addEventListener('input', (e) => goToPage('clientes', 1, e.target.value));

        // PRODUTOS CRUD EVENTS
        document.getElementById('form-add-produto').addEventListener('submit', e => { 
            e.preventDefault(); 
            const id = document.getElementById('produto-id').value;
            const nome = document.getElementById('nome-produto').value;
            const quantidade = parseInt(document.getElementById('qtd-produto').value);
            const preco = parseFloat(document.getElementById('preco-produto').value);

            if (isNaN(quantidade) || quantidade < 0) { showNotification('Quantidade deve ser um número não negativo.', true); return; }
            if (isNaN(preco) || preco <= 0) { showNotification('Preço deve ser um número positivo.', true); return; }

            if (id) { // Editing existing product
                const index = produtos.findIndex(p => p.id == id);
                if (index !== -1) {
                    produtos[index] = { ...produtos[index], nome, quantidade, preco };
                    showNotification('Produto atualizado!');
                }
            } else { // Adding new product
                produtos.push({ id: Date.now(), nome, quantidade, preco }); 
                showNotification('Produto salvo!'); 
            }
            saveData('produtos', produtos); 
            renderProdutos(); 
            popularFormulariosVenda(); // Update product dropdowns
            populateUpdateStockProductSelect(); // Update stock product dropdown
        });

        document.getElementById('btn-cancelar-produto').addEventListener('click', () => resetForm('form-add-produto', 'produto'));

        document.getElementById('tabela-produtos-container').addEventListener('click', e => {
            const target = e.target;
            const id = parseInt(target.getAttribute('data-id'));
            const type = target.getAttribute('data-type');
            if (target.classList.contains('btn-edit') && type === 'produto') {
                editItem(id, type);
            } else if (target.classList.contains('btn-delete') && type === 'produto') {
                deleteItem(id, type);
            }
        });

        document.getElementById('search-produtos').addEventListener('input', (e) => goToPage('produtos', 1, e.target.value, document.getElementById('filter-estoque-qtd').value));
        document.getElementById('filter-estoque-qtd').addEventListener('change', (e) => goToPage('produtos', 1, document.getElementById('search-produtos').value, e.target.value));


        // UPDATE STOCK EVENTS
        document.getElementById('form-update-stock').addEventListener('submit', e => {
            e.preventDefault();
            const productId = parseInt(document.getElementById('update-stock-product').value);
            const quantity = parseInt(document.getElementById('update-stock-quantity').value);
            const type = document.getElementById('update-stock-type').value;

            if (!productId || isNaN(quantity) || quantity <= 0) {
                showNotification('Selecione um produto e insira uma quantidade válida.', true);
                return;
            }

            const productIndex = produtos.findIndex(p => p.id === productId);
            if (productIndex === -1) {
                showNotification('Produto não encontrado.', true);
                return;
            }

            if (type === 'add') {
                produtos[productIndex].quantidade += quantity;
                showNotification(`Estoque de ${produtos[productIndex].nome} aumentado em ${quantity}.`);
            } else if (type === 'remove') {
                if (produtos[productIndex].quantidade < quantity) {
                    showNotification(`Não é possível remover ${quantity} unidades. Apenas ${produtos[productIndex].quantidade} em estoque.`, true);
                    return;
                }
                produtos[productIndex].quantidade -= quantity;
                showNotification(`Estoque de ${produtos[productIndex].nome} diminuído em ${quantity}.`);
            }

            saveData('produtos', produtos);
            renderProdutos();
            popularFormulariosVenda(); // Re-populate to show updated quantities in sales
            populateUpdateStockProductSelect(); // Re-populate to show updated quantities in stock update
        });

        // FLUXO DE CAIXA CRUD EVENTS
        document.getElementById('form-add-lancamento').addEventListener('submit', e => { 
            e.preventDefault(); 
            const id = document.getElementById('lancamento-id').value;
            const desc = document.getElementById('desc-lancamento').value; 
            const valor = parseFloat(document.getElementById('valor-lancamento').value); 
            const tipo = document.getElementById('tipo-lancamento').value; 

            if(!desc || isNaN(valor) || valor <= 0){ 
                showNotification('Preencha todos os campos corretamente (valor deve ser positivo)!', true); 
                return;
            }

            if (id) { // Editing existing lancamento
                const index = fluxoCaixa.findIndex(l => l.id == id);
                if (index !== -1) {
                    fluxoCaixa[index] = { ...fluxoCaixa[index], descricao: desc, valor, tipo };
                    showNotification('Lançamento atualizado!');
                }
            } else { // Adding new lancamento
                fluxoCaixa.push({ id: Date.now(), data: new Date().toISOString().split('T')[0], tipo, descricao: desc, valor }); 
                showNotification('Lançamento realizado!'); 
            }
            saveData('fluxoCaixa', fluxoCaixa); 
            renderFluxoCaixa(); 
            renderDashboardSummaries(); // Refresh dashboard balance
        });

        document.getElementById('btn-cancelar-lancamento').addEventListener('click', () => resetForm('form-add-lancamento', 'lancamento'));

        document.getElementById('tabela-caixa-container').addEventListener('click', e => {
            const target = e.target;
            const id = parseInt(target.getAttribute('data-id'));
            const type = target.getAttribute('data-type');
            if (target.classList.contains('btn-edit') && type === 'lancamento') {
                editItem(id, type);
            } else if (target.classList.contains('btn-delete') && type === 'lancamento') {
                deleteItem(id, type);
            }
        });

        document.getElementById('search-caixa').addEventListener('input', (e) => goToPage('caixa', 1, e.target.value, document.getElementById('filter-caixa-tipo').value));
        document.getElementById('filter-caixa-tipo').addEventListener('change', (e) => goToPage('caixa', 1, document.getElementById('search-caixa').value, e.target.value));

        // VENDAS EVENTS
        document.getElementById('btn-add-item-venda').addEventListener('click', addItemAoCarrinho);
        document.getElementById('venda-itens-container').addEventListener('click', e => { 
            if(e.target.classList.contains('btn-delete') && e.target.getAttribute('data-type') === 'carrinho') { 
                const id = parseInt(e.target.getAttribute('data-id')); 
                carrinhoVenda = carrinhoVenda.filter(item => item.produtoId !== id); 
                renderCarrinho(); 
                showNotification('Item removido do carrinho.');
            } 
        });
        document.getElementById('venda-pagamento').addEventListener('change', e => {
            document.getElementById('venda-parcelas-group').classList.toggle('hidden', e.target.value !== 'parcelado');
        });
        document.getElementById('btn-finalizar-venda').addEventListener('click', finalizarVenda);
        
        // CONTAS A RECEBER EVENTS
        document.getElementById('tabela-contas-container').addEventListener('click', e => {
            const target = e.target;
            const id = parseInt(target.getAttribute('data-id'));
            const type = target.getAttribute('data-type');

            if(target.classList.contains('btn-paid')) {
                const conta = contasAReceber.find(c => c.id === id);
                if(conta && conta.status === 'Pendente') {
                    if (!confirm(`Confirmar o recebimento de ${formatCurrency(conta.valor)} da conta nº ${id}?`)) return;
                    conta.status = 'Pago';
                    const clienteNome = clientes.find(c => c.id === conta.clienteId)?.nome || 'Avulso';
                    fluxoCaixa.push({ id: Date.now(), data: new Date().toISOString().split('T')[0], tipo: 'Entrada', descricao: `Recebimento de ${clienteNome} (Venda #${conta.vendaId})`, valor: conta.valor });
                    saveData('contasAReceber', contasAReceber);
                    saveData('fluxoCaixa', fluxoCaixa);
                    renderContasAReceber();
                    renderDashboardSummaries(); // Refresh dashboard totals
                    showNotification('Baixa realizada e valor lançado no caixa!');
                } else {
                    showNotification('Esta conta já foi paga.', true);
                }
            } else if (target.classList.contains('btn-info') && type === 'venda-detalhes') {
                showVendaDetalhesModal(id);
            }
        });
        document.getElementById('search-contas-receber').addEventListener('input', (e) => goToPage('contas-receber', 1, e.target.value, document.getElementById('filter-contas-receber-status').value));
        document.getElementById('filter-contas-receber-status').addEventListener('change', (e) => goToPage('contas-receber', 1, document.getElementById('search-contas-receber').value, e.target.value));


        // CONTAS A PAGAR CRUD EVENTS
        document.getElementById('form-add-conta-pagar').addEventListener('submit', e => {
            e.preventDefault();
            const id = document.getElementById('conta-pagar-id').value;
            const descricao = document.getElementById('desc-conta-pagar').value;
            const valor = parseFloat(document.getElementById('valor-conta-pagar').value);
            const dataVencimento = document.getElementById('vencimento-conta-pagar').value;

            if (!descricao || isNaN(valor) || valor <= 0 || !dataVencimento) {
                showNotification('Preencha todos os campos corretamente (valor deve ser positivo)!', true);
                return;
            }

            if (id) {
                const index = contasAPagar.findIndex(c => c.id == id);
                if (index !== -1) {
                    contasAPagar[index] = { ...contasAPagar[index], descricao, valor, dataVencimento };
                    showNotification('Conta a Pagar atualizada!');
                }
            } else {
                contasAPagar.push({ id: Date.now(), descricao, valor, dataVencimento, status: 'Pendente' });
                showNotification('Conta a Pagar registrada!');
            }
            saveData('contasAPagar', contasAPagar);
            renderContasAPagar();
            renderDashboardSummaries();
        });

        document.getElementById('btn-cancelar-conta-pagar').addEventListener('click', () => resetForm('form-add-conta-pagar', 'conta-pagar'));

        document.getElementById('tabela-contas-pagar-container').addEventListener('click', e => {
            const target = e.target;
            const id = parseInt(target.getAttribute('data-id'));
            const type = target.getAttribute('data-type');

            if (target.classList.contains('btn-paid') && type === 'conta-pagar') {
                const conta = contasAPagar.find(c => c.id === id);
                if (conta && conta.status === 'Pendente') {
                    if (!confirm(`Confirmar o pagamento de ${formatCurrency(conta.valor)} da conta: ${conta.descricao}?`)) return;
                    conta.status = 'Pago';
                    fluxoCaixa.push({ id: Date.now(), data: new Date().toISOString().split('T')[0], tipo: 'Saída', descricao: `Pagamento: ${conta.descricao} (Conta Pagar #${conta.id})`, valor: conta.valor });
                    saveData('contasAPagar', contasAPagar);
                    saveData('fluxoCaixa', fluxoCaixa);
                    renderContasAPagar();
                    renderDashboardSummaries();
                    showNotification('Pagamento realizado e valor lançado no caixa!');
                } else {
                    showNotification('Esta conta já foi paga.', true);
                }
            } else if (target.classList.contains('btn-edit') && type === 'conta-pagar') {
                editItem(id, type);
            } else if (target.classList.contains('btn-delete') && type === 'conta-pagar') {
                deleteItem(id, type);
            }
        });
        document.getElementById('search-contas-pagar').addEventListener('input', (e) => goToPage('contas-pagar', 1, e.target.value, document.getElementById('filter-contas-pagar-status').value));
        document.getElementById('filter-contas-pagar-status').addEventListener('change', (e) => goToPage('contas-pagar', 1, document.getElementById('search-contas-pagar').value, e.target.value));


        // BACKUP/RESTORE BUTTONS
        document.getElementById('btn-backup-data').addEventListener('click', backupData);
        document.getElementById('btn-restore-data').addEventListener('click', () => {
            document.getElementById('backup-file-input').click(); // Trigger file input click
        });
        document.getElementById('backup-file-input').addEventListener('change', restoreData);
        
        // THEME TOGGLE EVENT
        document.getElementById('theme-toggle-switch').addEventListener('change', (e) => {
            const theme = e.target.checked ? 'dark' : 'light';
            applyTheme(theme);
            localStorage.setItem('theme', theme);
            // Re-render charts or other elements that might be affected by theme for consistency
            renderDashboardSummaries();
        });


        // Initial load check
        if (localStorage.getItem('isLoggedIn') === 'true') {
            dashboardScreen.classList.remove('hidden');
            init();
        } else {
            loginScreen.classList.remove('hidden');
            document.getElementById('username').focus();
        }
    });
    </script>
</body>
</html>
