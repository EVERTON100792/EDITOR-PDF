<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flor de Maria - Sistema de Gestão</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-color: #d81b60; /* Rosa Escuro (Flor) */
            --secondary-color: #c2185b; /* Rosa Mais Escuro */
            --background-color: #1a1a2e; /* Azul Marinho Escuro */
            --sidebar-bg: #16213e; /* Azul Escuro */
            --content-bg: #16213e; /* Mesma cor do sidebar */
            --text-color: #b0c4de; /* Azul Aço Claro */
            --heading-color: #ffffff; /* Branco */
            --border-color: #2a3f50; /* Borda sutil */
            --sidebar-text: #94a3b8;
            --sidebar-text-hover: #ffffff;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            --border-radius: 12px;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body.loading > * {
            display: none;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
        }
        
        #login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            transition: opacity 0.5s ease-out;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .login-container {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            padding: 40px 30px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,.2);
            width: 90%;
            max-width: 400px;
            text-align: center;
            transform: scale(.95);
            animation: scaleIn .5s forwards;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        @keyframes scaleIn { to { transform:scale(1) } }

        .login-container h2 { color: #ffffff; margin-bottom: 10px; font-size: 2.2rem; font-weight: 700; }
        .login-container .logo i { text-shadow: 0 0 10px var(--primary-color); }
        .login-container p { color: #e0e0e0; margin-bottom: 30px; }
        
        .input-group { position: relative; margin-bottom: 25px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-color); }
        .input-group input, .input-group select {
            width: 100%; padding: 15px; padding-left: 45px;
            border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem;
            transition: all .3s;
            background-color: #2a3f50;
            color: var(--heading-color);
        }
        .input-group select { padding-left: 15px; appearance: none; }
        .input-group input:focus, .input-group select:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(216, 27, 96, 0.4);
        }
        .input-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-color); }
        .login-container .input-group input { background-color: rgba(255,255,255,0.9); color: #333; }
        
        .login-btn, .primary-btn {
            width: 100%; padding: 15px; border: none; border-radius: 8px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: #fff; font-size: 1.1rem; font-weight: 600;
            cursor: pointer; transition: all .2s;
        }
        .login-btn:hover, .primary-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(216, 27, 96, 0.5);
        }

        .primary-btn:disabled, select:disabled, input:disabled { 
            background: #555; 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none; 
            color: #888; 
            border-color: #444;
            opacity: 0.6;
        }
        
        .secondary-btn {
             background: #4A5568; color: #fff; padding: 5px 10px; font-size: .8rem; border-radius: 5px; cursor: pointer; transition: all .2s; border: none;
        }
        .secondary-btn:hover { background: #2D3748; }

        #main-app {
            display: none;
            grid-template-columns: 260px 1fr;
            grid-template-rows: auto 1fr;
            min-height: 100vh;
            grid-template-areas: "sidebar header" "sidebar content";
            transition: grid-template-columns .3s ease;
        }

        .sidebar {
            grid-area: sidebar; background-color: var(--sidebar-bg); color: var(--sidebar-text);
            padding: 20px; display: flex; flex-direction: column; transition: transform .3s ease;
            border-right: 1px solid var(--border-color);
        }
        .sidebar-header { display: flex; align-items: center; gap: 15px; margin-bottom: 40px; }
        .sidebar-header .logo-icon { font-size: 2rem; color: var(--primary-color); }
        .sidebar-header h2 { font-size: 1.5rem; font-weight: 600; color: var(--heading-color); }
        .sidebar-menu ul { list-style: none; }
        .sidebar-menu li a {
            display: flex; align-items: center; gap: 15px; padding: 15px 10px;
            border-radius: 8px; color: var(--sidebar-text); text-decoration: none;
            font-weight: 500; transition: background-color .3s, color .3s;
        }
        .sidebar-menu li a:hover, .sidebar-menu li a.active {
            background-color: rgba(216, 27, 96, 0.15); color: var(--sidebar-text-hover);
        }
        .sidebar-menu li a i { width: 20px; text-align: center; }
        .sidebar-footer { margin-top: auto; }

        .header {
            grid-area: header; display: flex; justify-content: space-between; align-items: center;
            padding: 20px; background-color: var(--sidebar-bg);
            border-bottom: 1px solid var(--border-color); z-index: 10;
        }
        .header .menu-toggle { display: none; cursor: pointer; font-size: 1.5rem; color: var(--text-color); }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .cart-icon-wrapper {
            position: relative;
            color: var(--text-color);
            font-size: 1.5rem;
        }

        .cart-badge {
            position: absolute; top: -8px; right: -10px;
            background-color: var(--danger-color); color: white;
            border-radius: 50%; width: 20px; height: 20px;
            display: flex; justify-content: center; align-items: center;
            font-size: 0.75rem; font-weight: 600; border: 2px solid var(--sidebar-bg);
            transition: transform .2s; transform: scale(0);
        }
        .cart-badge.visible {
            transform: scale(1);
        }

        .header .user-info { display: flex; align-items: center; gap: 15px; }
        .header .user-info img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .header .user-info span strong { color: var(--heading-color); }

        .main-content { grid-area: content; padding: 30px; overflow-y: auto; position: relative; }
        .page-content { display: none; }
        .page-content.active { display: block; animation: fadeIn .5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px) } to { opacity: 1; transform: translateY(0) } }

        .page-header { margin-bottom: 30px; }
        .page-header h1 { font-size: 2rem; font-weight: 600; color: var(--heading-color); }
        .page-header p { color: var(--text-color); }

        .cards-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; }
        .card {
            background-color: var(--content-bg); padding: 25px; border-radius: var(--border-radius);
            box-shadow: var(--shadow); display: flex; align-items: center; gap: 20px;
            transition: transform .3s, box-shadow .3s, border-color .3s;
            border: 1px solid var(--border-color);
        }
        .card:hover { transform: translateY(-5px); border-color: var(--primary-color); }
        .card .icon-wrapper { font-size: 2rem; padding: 20px; border-radius: 50%; display: flex; justify-content: center; align-items: center; }
        .card.revenue .icon-wrapper { background-color: rgba(216, 27, 96, 0.1); color: var(--primary-color); }
        .card.sales .icon-wrapper { background-color: rgba(16, 185, 129, 0.1); color: var(--success-color); }
        .card.customers .icon-wrapper { background-color: rgba(245, 158, 11, 0.1); color: var(--warning-color); }
        .card.products .icon-wrapper { background-color: rgba(63, 81, 181, 0.1); color: #3f51b5; }

        .card-info h3 { font-size: 2.2rem; font-weight: 600; color: var(--heading-color); }
        .card-info p { color: var(--text-color); }

        .content-block { margin-top: 40px; background-color: var(--content-bg); padding: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .content-block:first-child { margin-top: 0; }
        .content-block-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .content-block-header h2 { font-size: 1.5rem; color: var(--heading-color); }
        .primary-btn { width: auto; font-size: 1rem; padding: 10px 20px; }
        
        .danger-btn {
            background: transparent; border: 1px solid var(--danger-color); color: var(--danger-color);
            padding: 5px 10px; font-size: .8rem; border-radius: 5px; cursor: pointer; transition: all .2s;
        }
        .danger-btn:hover { background: var(--danger-color); color: #fff; }
        
        table { width: 100%; border-collapse: collapse; color: var(--text-color); }
        table th, table td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        table th { font-weight: 600; color: var(--heading-color); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
        table tbody tr:hover { background-color: rgba(42, 63, 80, 0.5); }
        table tfoot tr { border-top: 2px solid var(--primary-color); font-weight: 700; }
        table tfoot td { font-size: 1.2rem; color: var(--heading-color); }
        table .actions i { cursor: pointer; margin-right: 15px; color: #777; transition: color .2s; font-size: 1.1rem; }
        table .actions i.fa-trash:hover { color: var(--danger-color); }
        table .actions i.fa-edit:hover { color: var(--primary-color); }
        .stock-adjust-cell { display: flex; align-items: center; gap: 10px; }
        .stock-adjust-cell input { width: 70px; padding: 8px; }

        .status { padding: 5px 12px; border-radius: 20px; font-size: .8rem; font-weight: 600; text-align: center; }
        .status.paid { background-color: rgba(16, 185, 129, 0.2); color: #10b981; }
        .status.pending { background-color: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .status.low-stock { background-color: rgba(245, 158, 11, 0.2); color: #f59e0b; }

        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: var(--sidebar-bg); margin: 10% auto; padding: 30px;
            border-radius: var(--border-radius); width: 90%; max-width: 500px;
            animation: scaleIn .3s; border: 1px solid var(--border-color);
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { color: var(--heading-color); }
        .close-btn { color: #aaa; font-size: 28px; font-weight: 700; cursor: pointer; transition: color .2s; }
        .close-btn:hover { color: var(--heading-color); }
        .modal-body form .input-group { margin-bottom: 15px; }

        #notification-container {
            position: fixed; top: 20px; right: 20px; z-index: 9999;
            display: flex; flex-direction: column; gap: 10px;
        }
        .notification {
            padding: 15px 20px; border-radius: 8px; color: #fff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex; align-items: center; gap: 15px;
            opacity: 0; transform: translateX(100%);
            animation: slideInNotification .5s forwards;
        }
        @keyframes slideInNotification {
            to { opacity: 1; transform: translateX(0); }
        }
        .notification.success { background-color: var(--success-color); }
        .notification.error { background-color: var(--danger-color); }
        .notification.info { background-color: var(--primary-color); }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }
        .chart-container {
            background-color: var(--content-bg); padding: 30px; border-radius: var(--border-radius);
            box-shadow: var(--shadow); border: 1px solid var(--border-color);
        }
        .chart-container h2 { font-size: 1.5rem; color: var(--heading-color); margin-bottom: 20px; }
        .full-width-chart {
            grid-column: 1 / -1;
        }

        @media (max-width: 768px) {
            #main-app {
                grid-template-columns: 1fr;
                grid-template-areas: "header" "content";
            }
            .sidebar {
                position: fixed; left: 0; top: 0; height: 100%; z-index: 1000;
                transform: translateX(-100%);
            }
            .sidebar.show {
                transform: translateX(0);
                box-shadow: 10px 0 20px rgba(0,0,0,.1);
            }
            .header .menu-toggle { display: block; }
            .main-content { padding: 20px; }
            .page-header h1 { font-size: 1.8rem; }
            .content-block, .chart-container { padding: 20px; }
        }
    </style>
</head>
<body class="loading">

    <div id="login-screen" style="display: none;">
        <div class="login-container">
            <h2 class="logo"><i class="fas fa-spa"></i> Flor de Maria</h2>
            <p>Faça login para gerenciar seu negócio</p>
            <form id="login-form">
                <div class="input-group">
                    <i class="fas fa-user"></i>
                    <input type="text" placeholder="Usuário" required value="admin">
                </div>
                <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" placeholder="Senha" required value="1234">
                </div>
                <button type="submit" class="login-btn">Entrar</button>
            </form>
        </div>
    </div>

    <div id="main-app" style="display: none;">
        <aside class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-spa logo-icon"></i>
                <h2>Flor de Maria</h2>
            </div>
            <nav class="sidebar-menu">
                <ul>
                    <li><a href="#" class="nav-link" data-target="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                    <li><a href="#" class="nav-link" data-target="cashier"><i class="fas fa-cash-register"></i> Caixa</a></li>
                    <li><a href="#" class="nav-link" data-target="products"><i class="fas fa-tshirt"></i> Produtos</a></li>
                    <li><a href="#" class="nav-link" data-target="inventory"><i class="fas fa-boxes-stacked"></i> Estoques</a></li>
                    <li><a href="#" class="nav-link" data-target="customers"><i class="fas fa-users"></i> Clientes</a></li>
                    <li><a href="#" class="nav-link" data-target="debts"><i class="fas fa-hand-holding-usd"></i> Contas a Receber</a></li>
                    <li><a href="#" class="nav-link" data-target="reports"><i class="fas fa-chart-pie"></i> Relatórios</a></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <a href="#" id="logout-btn" class="nav-link"><i class="fas fa-sign-out-alt"></i> Sair</a>
            </div>
        </aside>

        <header class="header">
            <i class="fas fa-bars menu-toggle"></i>
            <div class="header-actions">
                <div id="cart-icon-wrapper" class="cart-icon-wrapper">
                    <i class="fas fa-shopping-cart"></i>
                    <span id="cart-item-count" class="cart-badge">0</span>
                </div>
                <div class="user-info">
                    <span>Olá, <strong>Admin</strong></span>
                    <img src="https://i.pravatar.cc/150?img=32" alt="Foto do Usuário">
                </div>
            </div>
        </header>

        <main class="main-content">
            <div id="dashboard" class="page-content">
                <div class="page-header">
                    <h1>Dashboard</h1>
                    <p>Visão geral e desempenho financeiro do seu negócio.</p>
                </div>
                <div class="cards-container" id="dashboard-cards"></div>
                <div class="charts-grid">
                    <div class="chart-container full-width-chart">
                        <h2>Receita por Mês (Últimos 12 meses)</h2>
                        <canvas id="dashboard-revenue-chart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h2>Produtos Mais Vendidos (Top 5)</h2>
                        <canvas id="dashboard-top-products-chart"></canvas>
                    </div>
                     <div class="chart-container">
                        <h2>Vendas por Forma de Pagamento</h2>
                        <canvas id="dashboard-payment-method-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <div id="cashier" class="page-content">
                <div class="page-header"><h1>Caixa (Ponto de Venda)</h1></div>
                <div class="content-block">
                    <h2 style="margin-bottom: 20px; color: var(--heading-color);">1. Adicionar Produto ao Carrinho</h2>
                    <form id="add-to-cart-form">
                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; align-items: flex-end;">
                            <div class="input-group" style="margin:0;"><label>Produto</label><select id="cashier-product" required></select></div>
                            <div class="input-group" style="margin:0;"><label>Qtd.</label><input type="number" id="cashier-quantity" value="1" min="1" required></div>
                            <button type="submit" id="add-to-cart-btn" class="primary-btn">Adicionar</button>
                        </div>
                    </form>
                </div>
                <div class="content-block">
                    <h2 style="margin-bottom: 20px; color: var(--heading-color);">2. Carrinho e Finalização</h2>
                    <form id="checkout-form">
                        <div id="current-sale-cart"></div>
                        <div id="checkout-controls">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                                <div class="input-group"><label>Cliente</label><select id="cashier-customer" required></select></div>
                                <div class="input-group"><label>Forma de Pagamento</label><select id="cashier-payment-method" required><option value="Dinheiro">Dinheiro</option><option value="Cartão de Crédito">Cartão de Crédito</option><option value="Cartão de Débito">Cartão de Débito</option><option value="Pix">Pix</option><option value="Fiado">Fiado</option></select></div>
                            </div>
                            <button type="submit" id="finalize-sale-btn" class="primary-btn" style="width: 100%; margin-top: 20px;">Finalizar Venda</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div id="products" class="page-content">
                <div class="page-header"><h1>Gestão de Produtos</h1></div>
                <div class="content-block">
                    <div class="content-block-header">
                        <h2>Lista de Produtos</h2>
                        <button id="add-product-btn" class="primary-btn"><i class="fas fa-plus"></i> Novo Produto</button>
                    </div>
                    <table>
                        <thead><tr><th>SKU</th><th>Produto</th><th>Preço</th><th>Estoque</th><th>Ações</th></tr></thead>
                        <tbody id="products-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="inventory" class="page-content">
                <div class="page-header">
                    <h1>Gestão de Estoques</h1>
                    <p>Adicione, remova ou ajuste a quantidade de produtos em seu inventário.</p>
                </div>
                <div class="content-block">
                    <div class="content-block-header"><h2>Controle de Inventário</h2></div>
                     <table>
                        <thead><tr><th>SKU</th><th>Produto</th><th>Estoque Atual</th><th style="text-align: right;">Ajustar Estoque</th></tr></thead>
                        <tbody id="inventory-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="customers" class="page-content">
                <div class="page-header"><h1>Gestão de Clientes</h1></div>
                <div class="content-block">
                    <div class="content-block-header">
                        <h2>Lista de Clientes</h2>
                        <button id="add-customer-btn" class="primary-btn"><i class="fas fa-plus"></i> Novo Cliente</button>
                    </div>
                    <table>
                        <thead><tr><th>Nome</th><th>Contato</th><th>Desde</th><th>Ações</th></tr></thead>
                        <tbody id="customers-table-body"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="debts" class="page-content">
                <div class="page-header">
                    <h1>Contas a Receber (Fiado)</h1>
                    <p>Liste e gerencie as vendas pendentes de pagamento.</p>
                </div>
                <div class="content-block">
                    <div class="content-block-header"><h2>Vendas Pendentes</h2></div>
                    <table>
                        <thead><tr><th>Cliente</th><th>Data da Venda</th><th>Total</th><th>Status</th><th>Ação</th></tr></thead>
                        <tbody id="debts-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="reports" class="page-content">
                <div class="page-header">
                    <h1>Relatórios</h1>
                    <p>Analise o desempenho do seu negócio com gráficos interativos.</p>
                </div>
                 <div class="charts-grid">
                    <div class="chart-container full-width-chart">
                        <h2>Receita por Mês (Últimos 12 meses)</h2>
                        <canvas id="reports-revenue-chart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h2>Produtos Mais Vendidos (Top 10)</h2>
                        <canvas id="reports-top-products-chart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h2>Vendas por Forma de Pagamento</h2>
                        <canvas id="reports-payment-method-chart"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <div id="customer-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="customer-modal-title">Novo Cliente</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <form id="customer-form">
                    <input type="hidden" id="customer-id">
                    <div class="input-group"><input type="text" id="customer-name" placeholder="Nome completo" required></div>
                    <div class="input-group"><input type="tel" id="customer-contact" placeholder="Telefone / WhatsApp" required></div>
                    <button type="submit" class="primary-btn">Salvar Cliente</button>
                </form>
            </div>
        </div>
    </div>

    <div id="product-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="product-modal-title">Novo Produto</h2>
                <span class="close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <form id="product-form">
                    <input type="hidden" id="product-id">
                    <div class="input-group"><input type="text" id="product-name" placeholder="Nome do Produto" required></div>
                    <div class="input-group"><input type="text" id="product-sku" placeholder="SKU (Código Único)" required></div>
                    <div class="input-group"><input type="number" id="product-price" placeholder="Preço (ex: 49.90)" step="0.01" required></div>
                    <div class="input-group"><input type="number" id="product-stock" placeholder="Quantidade em Estoque" required></div>
                    <button type="submit" class="primary-btn">Salvar Produto</button>
                </form>
            </div>
        </div>
    </div>
    
    <div id="notification-container"></div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- ELEMENTOS GLOBAIS ---
        let db;
        let currentSale = { items: [], total: 0 };
        let chartInstances = {};
        
        const mainApp = document.getElementById('main-app');
        const loginScreen = document.getElementById('login-screen');
        const loginForm = document.getElementById('login-form');
        const cartItemCount = document.getElementById('cart-item-count');
        const customerModal = document.getElementById('customer-modal');
        const productModal = document.getElementById('product-modal');
        const modals = { customer: customerModal, product: productModal };
        const navLinks = document.querySelectorAll('.nav-link');
        const pages = document.querySelectorAll('.page-content');
        const menuToggle = document.querySelector('.menu-toggle');
        const sidebar = document.querySelector('.sidebar');

        Chart.defaults.color = '#b0c4de';
        Chart.defaults.borderColor = '#2a3f50';

        // --- FUNÇÕES PRINCIPAIS ---

        function showNotification(message, type = 'success', duration = 3000) {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            const icon = type === 'success' ? 'fa-check-circle' : (type === 'error' ? 'fa-times-circle' : 'fa-info-circle');
            notification.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
            container.appendChild(notification);
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 500);
            }, duration);
        }

        function loadDatabase() {
            const dbJSON = localStorage.getItem('flordeMariaDB');
            if (dbJSON) {
                db = JSON.parse(dbJSON);
            } else {
                db = {
                    products: [
                        {id: Date.now() + 1, name: "Vestido Floral Curto", sku: "VFC-001", price: 189.90, stock: 25},
                        {id: Date.now() + 2, name: "Blusa de Seda Branca", sku: "BSB-002", price: 119.90, stock: 40},
                        {id: Date.now() + 3, name: "Saia Midi Plissada", sku: "SMP-003", price: 159.99, stock: 30},
                        {id: Date.now() + 4, name: "Calça Pantalona Preta", sku: "CPP-004", price: 210.00, stock: 20}
                    ],
                    customers: [
                        {id: Date.now() + 5, name: "Ana Carolina", contact: "11987654321", since: "01/01/2024"},
                        {id: Date.now() + 6, name: "Beatriz Almeida", contact: "21912345678", since: "15/02/2024"}
                    ],
                    sales: []
                };
                saveDatabase();
            }
        }

        function saveDatabase() {
            localStorage.setItem('flordeMariaDB', JSON.stringify(db));
        }

        function renderAll(pageToRefresh = null) {
            if (!db) return;
            
            // Renderiza apenas a página ativa ou todas se nenhuma for especificada
            const activePage = pageToRefresh || sessionStorage.getItem('activePage') || 'dashboard';

            if (activePage === 'dashboard') renderDashboard();
            if (activePage === 'products') renderProductsTable();
            if (activePage === 'inventory') renderInventoryPage();
            if (activePage === 'customers') renderCustomersTable();
            if (activePage === 'debts') renderDebtsPage();
            if (activePage === 'cashier') initializeCashierPage();
            if (activePage === 'reports') renderReportsPage();

            // Renderiza componentes que precisam de atualização constante em segundo plano
            if (activePage !== 'dashboard') renderDashboardCards(); // Cards do dashboard sempre atualizados
        }

        // --- LÓGICA DE NAVEGAÇÃO E PÁGINAS ---

        function navigateToPage(targetId) {
            if (!targetId || !document.getElementById(targetId)) {
                targetId = 'dashboard'; 
            }
            
            destroyAllCharts();

            // Chamadas de renderização específicas da página
            if (targetId === 'cashier') initializeCashierPage();
            if (targetId === 'debts') renderDebtsPage();
            if (targetId === 'reports') renderReportsPage();
            if (targetId === 'dashboard') renderDashboard();
            if (targetId === 'products') renderProductsTable();
            if (targetId === 'customers') renderCustomersTable();
            if (targetId === 'inventory') renderInventoryPage();
            
            navLinks.forEach(n => n.classList.remove('active'));
            pages.forEach(p => p.classList.remove('active'));

            const activeLink = document.querySelector(`.nav-link[data-target="${targetId}"]`);
            const activePage = document.getElementById(targetId);

            if (activeLink) activeLink.classList.add('active');
            if (activePage) activePage.classList.add('active');
            
            sessionStorage.setItem('activePage', targetId);
            
            if (window.innerWidth <= 768 && sidebar.classList.contains('show')) {
                sidebar.classList.remove('show');
            }
        }
        
        function renderDashboardCards() {
             const totalRevenue = db.sales.filter(sale => sale.status === 'Pago').reduce((sum, sale) => sum + sale.total, 0);
             const totalProductsInStock = db.products.reduce((sum, product) => sum + product.stock, 0);
             document.getElementById('dashboard-cards').innerHTML = `
                <div class="card revenue"><div class="icon-wrapper"><i class="fas fa-dollar-sign"></i></div><div class="card-info"><h3>R$ ${totalRevenue.toFixed(2)}</h3><p>Receita (Pago)</p></div></div>
                <div class="card sales"><div class="icon-wrapper"><i class="fas fa-tags"></i></div><div class="card-info"><h3>${db.sales.length}</h3><p>Vendas Totais</p></div></div>
                <div class="card customers"><div class="icon-wrapper"><i class="fas fa-users"></i></div><div class="card-info"><h3>${db.customers.length}</h3><p>Clientes</p></div></div>
                <div class="card products"><div class="icon-wrapper"><i class="fas fa-boxes-stacked"></i></div><div class="card-info"><h3>${totalProductsInStock}</h3><p>Itens em Estoque</p></div></div>`;
        }

        function renderDashboard() {
            renderDashboardCards();
            renderDashboardCharts();
        }

        function renderProductsTable() {
            const tableBody = document.getElementById('products-table-body');
            tableBody.innerHTML = db.products.map(p => `<tr>
                <td>${p.sku}</td><td>${p.name}</td><td>R$ ${p.price.toFixed(2)}</td>
                <td><span class="status ${p.stock <= 5 ? 'pending' : ''}">${p.stock}</span></td>
                <td class="actions">
                    <i class="fas fa-edit" onclick="openEditModal('product', ${p.id})"></i>
                    <i class="fas fa-trash" onclick="deleteEntity('products', ${p.id})"></i>
                </td></tr>`).join('');
        }

        function renderCustomersTable() {
            const tableBody = document.getElementById('customers-table-body');
            tableBody.innerHTML = db.customers.map(c => `<tr>
                <td>${c.name}</td><td>${c.contact}</td><td>${c.since}</td>
                <td class="actions">
                    <i class="fas fa-edit" onclick="openEditModal('customer', ${c.id})"></i>
                    <i class="fas fa-trash" onclick="deleteEntity('customers', ${c.id})"></i>
                </td></tr>`).join('');
        }
        
        // --- LÓGICA DE ESTOQUE ---

        function renderInventoryPage() {
            const tableBody = document.getElementById('inventory-table-body');
            if(!tableBody) return;
            tableBody.innerHTML = db.products.map(p => `<tr>
                <td>${p.sku}</td>
                <td>${p.name}</td>
                <td><span class="status ${p.stock <= 5 ? (p.stock === 0 ? 'pending' : 'low-stock') : ''}">${p.stock}</span></td>
                <td class="stock-adjust-cell" style="text-align: right;">
                    <input type="number" class="input-group" id="stock-adjust-input-${p.id}" value="${p.stock}" min="0">
                    <button class="secondary-btn" onclick="adjustStock(${p.id})">Salvar</button>
                </td>
            </tr>`).join('');
        }

        window.adjustStock = (productId) => {
            const input = document.getElementById(`stock-adjust-input-${productId}`);
            const newStock = parseInt(input.value);

            if (isNaN(newStock) || newStock < 0) {
                showNotification('Por favor, insira um valor de estoque válido.', 'error');
                return;
            }

            const product = db.products.find(p => p.id === productId);
            if(product) {
                product.stock = newStock;
                saveDatabase();
                showNotification(`Estoque de "${product.name}" atualizado para ${newStock}.`, 'success');
                renderInventoryPage(); // Re-renderiza a tabela de estoque
                renderProductsTable(); // Re-renderiza a tabela de produtos também
            }
        };

        // --- LÓGICA DO CAIXA (VENDA) ---
        
        function initializeCashierPage() {
            const productSelect = document.getElementById('cashier-product');
            const customerSelect = document.getElementById('cashier-customer');
            const addToCartBtn = document.getElementById('add-to-cart-btn');

            productSelect.innerHTML = '<option value="">Selecione um produto...</option>' + 
                db.products.filter(p => p.stock > 0).map(p => `<option value="${p.id}">${p.name} (Estoque: ${p.stock})</option>`).join('');
            
            customerSelect.innerHTML = '<option value="0">Consumidor Final</option>' + 
                db.customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

            addToCartBtn.disabled = true;
            productSelect.addEventListener('change', function() {
                addToCartBtn.disabled = !this.value;
            });
            
            renderCurrentSaleCart();
        }
        
        function toggleCheckoutControls(enabled) {
            document.getElementById('cashier-customer').disabled = !enabled;
            document.getElementById('cashier-payment-method').disabled = !enabled;
            document.getElementById('finalize-sale-btn').disabled = !enabled;
        }
        
        function renderCurrentSaleCart() {
            const cartContainer = document.getElementById('current-sale-cart');
            
            if (currentSale.items.length === 0) {
                cartContainer.innerHTML = '<p style="text-align:center; padding: 20px 0;">Seu carrinho está vazio.</p>';
                toggleCheckoutControls(false);
                return;
            }

            currentSale.total = 0;
            const tableRows = currentSale.items.map(item => {
                const product = db.products.find(p => p.id === item.productId);
                if (!product) return '';
                const subtotal = item.quantity * product.price;
                currentSale.total += subtotal;
                return `<tr>
                    <td>${product.name}</td>
                    <td>${item.quantity}</td>
                    <td>R$ ${product.price.toFixed(2)}</td>
                    <td>R$ ${subtotal.toFixed(2)}</td>
                    <td><button type="button" class="danger-btn" onclick="removeFromCart(${product.id})">Remover</button></td>
                </tr>`;
            }).join('');

            cartContainer.innerHTML = `<table>
                <thead><tr><th>Produto</th><th>Qtd.</th><th>Preço Unit.</th><th>Subtotal</th><th>Ação</th></tr></thead>
                <tbody>${tableRows}</tbody>
                <tfoot><tr><td colspan="3">TOTAL</td><td colspan="2">R$ ${currentSale.total.toFixed(2)}</td></tr></tfoot>
            </table>`;
            
            toggleCheckoutControls(true);
        }

        document.getElementById('add-to-cart-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const productSelect = document.getElementById('cashier-product');
            const quantityInput = document.getElementById('cashier-quantity');
            const productId = parseInt(productSelect.value);
            const quantity = parseInt(quantityInput.value);

            if (!productId) { showNotification('Por favor, selecione um produto.', 'error'); return; }
            
            const product = db.products.find(p => p.id === productId);
            if (!product) { showNotification('Erro: Produto não encontrado.', 'error'); return; }

            const existingItem = currentSale.items.find(item => item.productId === productId);
            const totalQuantity = (existingItem ? existingItem.quantity : 0) + quantity;

            if (totalQuantity > product.stock) { showNotification(`Estoque insuficiente! Disponível: ${product.stock}`, 'error'); return; }
            
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                currentSale.items.push({ productId, quantity });
            }
            showNotification(`${product.name} adicionado ao carrinho.`, 'info');
            updateCartIcon();
            renderCurrentSaleCart();
            productSelect.value = "";
            quantityInput.value = 1; 
            document.getElementById('add-to-cart-btn').disabled = true;
        });
        
        window.removeFromCart = (productId) => {
            currentSale.items = currentSale.items.filter(item => item.productId !== productId);
            updateCartIcon();
            renderCurrentSaleCart();
        }

        document.getElementById('checkout-form').addEventListener('submit', function(e) {
            e.preventDefault();
            if (currentSale.items.length === 0) { showNotification('O carrinho está vazio!', 'error'); return; }

            const saleRecord = {
                id: Date.now(),
                customerId: parseInt(document.getElementById('cashier-customer').value),
                items: currentSale.items.map(item => {
                    // ATUALIZA O ESTOQUE AQUI
                    const product = db.products.find(p => p.id === item.productId);
                    if (product) {
                        product.stock -= item.quantity;
                    }
                    return {...item, priceAtSale: product ? product.price : 0};
                }),
                total: currentSale.total,
                paymentMethod: document.getElementById('cashier-payment-method').value,
                status: document.getElementById('cashier-payment-method').value === 'Fiado' ? 'Pendente' : 'Pago',
                date: new Date().toISOString()
            };

            db.sales.push(saleRecord);
            saveDatabase();
            showNotification('Venda registrada com sucesso!', 'success');
            
            currentSale = { items: [], total: 0 };
            updateCartIcon();
            initializeCashierPage();
            renderAll('dashboard'); // Atualiza o dashboard após a venda
        });

        // --- LÓGICA DE CONTAS A RECEBER ---

        function renderDebtsPage() {
            const tableBody = document.getElementById('debts-table-body');
            const pendingSales = db.sales.filter(s => s.status === 'Pendente').sort((a, b) => new Date(a.date) - new Date(b.date));
            if(pendingSales.length === 0){
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Nenhuma conta pendente.</td></tr>';
                return;
            }
            tableBody.innerHTML = pendingSales.map(sale => {
                const customer = db.customers.find(c => c.id === sale.customerId) || { name: 'Consumidor Final' };
                return `<tr>
                    <td>${customer.name}</td>
                    <td>${new Date(sale.date).toLocaleDateString('pt-BR')}</td>
                    <td>R$ ${sale.total.toFixed(2)}</td>
                    <td><span class="status pending">Pendente</span></td>
                    <td><button class="primary-btn" onclick="markDebtAsPaid(${sale.id})">Marcar como Pago</button></td>
                </tr>`;
            }).join('');
        }
        window.markDebtAsPaid = (saleId) => {
            const sale = db.sales.find(s => s.id === saleId);
            if(sale){
                sale.status = 'Pago';
                saveDatabase();
                showNotification('Conta marcada como paga com sucesso!', 'success');
                renderDebtsPage();
                renderDashboard();
            }
        }
        
        // --- LÓGICA DOS GRÁFICOS (CHARTS) ---

        function destroyAllCharts() {
            Object.values(chartInstances).forEach(chart => { if (chart) chart.destroy(); });
            chartInstances = {};
        }

        function createChart(canvasId, type, data, options) {
            const ctx = document.getElementById(canvasId);
            if (ctx) {
                 if (chartInstances[canvasId]) {
                    chartInstances[canvasId].destroy();
                }
                chartInstances[canvasId] = new Chart(ctx, { type, data, options });
            }
        }
        
        function renderDashboardCharts() {
            const last12Months = Array.from({length: 12}, (_, i) => { const d = new Date(); d.setMonth(d.getMonth() - i); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`; }).reverse();
            const revenueData = last12Months.reduce((acc, month) => ({...acc, [month]: 0}), {});
            db.sales.filter(s => s.status === 'Pago').forEach(sale => {
                const saleMonth = sale.date.substring(0, 7);
                if (revenueData[saleMonth] !== undefined) revenueData[saleMonth] += sale.total;
            });
            createChart('dashboard-revenue-chart', 'bar', {
                labels: last12Months.map(m => new Date(m+'-02').toLocaleString('pt-BR', { month: 'short', year: '2-digit' })),
                datasets: [{ label: 'Receita (R$)', data: Object.values(revenueData), backgroundColor: 'rgba(216, 27, 96, 0.6)', borderColor: 'rgba(216, 27, 96, 1)', borderWidth: 1 }]
            }, { responsive: true, scales: { y: { beginAtZero: true } } });

            const productSales = db.sales.flatMap(s => s.items).reduce((acc, item) => ({...acc, [item.productId]: (acc[item.productId] || 0) + item.quantity }), {});
            const sortedProducts = Object.entries(productSales).sort(([,a],[,b]) => b-a).slice(0, 5);
            createChart('dashboard-top-products-chart', 'bar', {
                labels: sortedProducts.map(([id]) => (db.products.find(p => p.id == id) || {name: '?'}).name),
                datasets: [{ label: 'Quantidade Vendida', data: sortedProducts.map(([,qty]) => qty), backgroundColor: 'rgba(216, 27, 96, 0.6)', borderColor: 'rgba(216, 27, 96, 1)', borderWidth: 1 }]
            }, { responsive: true, indexAxis: 'y' });
            
            const paymentData = db.sales.reduce((acc, sale) => ({...acc, [sale.paymentMethod]: (acc[sale.paymentMethod] || 0) + 1 }), {});
            createChart('dashboard-payment-method-chart', 'doughnut', {
                labels: Object.keys(paymentData),
                datasets: [{ data: Object.values(paymentData), backgroundColor: ['#d81b60', '#10b981', '#f59e0b', '#4f46e5', '#ef4444'], borderWidth: 0 }]
            }, { responsive: true, plugins: { legend: { position: 'top' } } });
        }

        function renderReportsPage() {
            const last12Months = Array.from({length: 12}, (_, i) => { const d = new Date(); d.setMonth(d.getMonth() - i); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`; }).reverse();
            const revenueData = last12Months.reduce((acc, month) => ({...acc, [month]: 0}), {});
            db.sales.filter(s => s.status === 'Pago').forEach(sale => {
                const saleMonth = sale.date.substring(0, 7);
                if (revenueData[saleMonth] !== undefined) revenueData[saleMonth] += sale.total;
            });
            createChart('reports-revenue-chart', 'bar', {
                labels: last12Months.map(m => new Date(m+'-02').toLocaleString('pt-BR', { month: 'short', year: '2-digit' })),
                datasets: [{ label: 'Receita (R$)', data: Object.values(revenueData), backgroundColor: 'rgba(216, 27, 96, 0.6)', borderColor: 'rgba(216, 27, 96, 1)', borderWidth: 1 }]
            }, { responsive: true, scales: { y: { beginAtZero: true } } });

            const paymentData = db.sales.reduce((acc, sale) => ({...acc, [sale.paymentMethod]: (acc[sale.paymentMethod] || 0) + 1 }), {});
            createChart('reports-payment-method-chart', 'doughnut', {
                labels: Object.keys(paymentData),
                datasets: [{ data: Object.values(paymentData), backgroundColor: ['#d81b60', '#10b981', '#f59e0b', '#4f46e5', '#ef4444'], borderWidth: 0 }]
            }, { responsive: true, plugins: { legend: { position: 'top' } } });

            const productSales = db.sales.flatMap(s => s.items).reduce((acc, item) => ({...acc, [item.productId]: (acc[item.productId] || 0) + item.quantity }), {});
            const sortedProducts = Object.entries(productSales).sort(([,a],[,b]) => b-a).slice(0, 10);
            createChart('reports-top-products-chart', 'bar', {
                labels: sortedProducts.map(([id]) => (db.products.find(p => p.id == id) || {name: 'Produto Deletado'}).name),
                datasets: [{ label: 'Quantidade Vendida', data: sortedProducts.map(([,qty]) => qty), backgroundColor: 'rgba(216, 27, 96, 0.6)', borderColor: 'rgba(216, 27, 96, 1)', borderWidth: 1 }]
            }, { responsive: true, indexAxis: 'y' });
        }
        
        // --- MODAIS E CRUD ---

        window.deleteEntity = (type, id) => {
            if(type === 'products' && db.sales.some(sale => sale.items.some(item => item.productId === id))) {
                 showNotification('Não é possível excluir produtos que já possuem vendas registradas.', 'error');
                 return;
            }
            if(type === 'customers' && db.sales.some(sale => sale.customerId === id)) {
                 showNotification('Não é possível excluir clientes que já possuem vendas registradas.', 'error');
                 return;
            }

            if (confirm(`Tem certeza que deseja excluir este item? Esta ação não pode ser desfeita.`)) {
                db[type] = db[type].filter(item => item.id !== id);
                saveDatabase();
                navigateToPage(sessionStorage.getItem('activePage')); // Re-renderiza a página atual
                showNotification('Item excluído com sucesso.', 'success');
            }
        }
        
        window.openEditModal = (type, id = null) => {
            const form = document.getElementById(`${type}-form`);
            form.reset();
            document.getElementById(`${type}-id`).value = '';
            const modal = modals[type];
            const title = document.getElementById(`${type}-modal-title`);
            if (id) {
                const item = db[type + 's'].find(i => i.id === id);
                if (!item) { showNotification('Item não encontrado.', 'error'); return; }
                title.innerText = `Editar ${type === 'customer' ? 'Cliente' : 'Produto'}`;
                document.getElementById(`${type}-id`).value = id;
                Object.keys(item).forEach(key => {
                    const input = form.querySelector(`#${type}-${key}`);
                    if (input) input.value = item[key];
                });
            } else {
                 title.innerText = `Novo ${type === 'customer' ? 'Cliente' : 'Produto'}`;
            }
            modal.style.display = 'block';
        }
        
        document.querySelectorAll('.modal .close-btn').forEach(btn => btn.onclick = () => btn.closest('.modal').style.display = 'none');
        document.getElementById('add-customer-btn').onclick = () => openEditModal('customer');
        document.getElementById('add-product-btn').onclick = () => openEditModal('product');

        document.getElementById('customer-form').addEventListener('submit', function(e){
            e.preventDefault();
            const id = parseInt(document.getElementById('customer-id').value);
            const customerData = { name: document.getElementById('customer-name').value, contact: document.getElementById('customer-contact').value };
            if(id) {
                const index = db.customers.findIndex(c => c.id === id);
                db.customers[index] = { ...db.customers[index], ...customerData };
            } else {
                customerData.id = Date.now();
                customerData.since = new Date().toLocaleDateString('pt-BR');
                db.customers.push(customerData);
            }
            saveDatabase();
            renderCustomersTable();
            this.reset();
            modals.customer.style.display='none';
            showNotification('Cliente salvo com sucesso!', 'success');
        });

        document.getElementById('product-form').addEventListener('submit', function(e){
            e.preventDefault();
            const id = parseInt(document.getElementById('product-id').value);
            const productData = { name: document.getElementById('product-name').value, sku: document.getElementById('product-sku').value, price: parseFloat(document.getElementById('product-price').value), stock: parseInt(document.getElementById('product-stock').value) };
            if(id) {
                const index = db.products.findIndex(p => p.id === id);
                db.products[index] = { ...db.products[index], ...productData };
            } else {
                productData.id = Date.now();
                db.products.push(productData);
            }
            saveDatabase();
            renderProductsTable();
            renderInventoryPage(); // Atualiza a página de estoques também
            this.reset();
            modals.product.style.display='none';
            showNotification('Produto salvo com sucesso!', 'success');
        });

        // --- AUTENTICAÇÃO E INICIALIZAÇÃO ---

        function updateCartIcon() {
            const count = currentSale.items.reduce((sum, item) => sum + item.quantity, 0);
            cartItemCount.innerText = count;
            cartItemCount.classList.toggle('visible', count > 0);
        }

        function showMainApp() {
            loadDatabase();
            loginScreen.style.display = 'none';
            mainApp.style.display = 'grid';
            const lastPage = sessionStorage.getItem('activePage') || 'dashboard';
            navigateToPage(lastPage);
        }

        function showLoginScreen() {
            destroyAllCharts();
            mainApp.style.display = 'none';
            loginScreen.style.display = 'flex';
            setTimeout(() => loginScreen.style.opacity = '1', 50);
        }
        
        function logout() {
             sessionStorage.removeItem('flordeMariaLoggedIn');
             sessionStorage.removeItem('activePage');
             showLoginScreen();
        }

        loginForm.addEventListener('submit', e => {
            e.preventDefault();
            sessionStorage.setItem('flordeMariaLoggedIn', 'true');
            showMainApp();
            showNotification('Login bem-sucedido!', 'success');
        });

        navLinks.forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                if (link.id === 'logout-btn') {
                    logout();
                    return;
                }
                navigateToPage(link.getAttribute('data-target'));
            });
        });

        menuToggle.addEventListener('click', () => sidebar.classList.toggle('show'));

        window.addEventListener('click', e => {
            if (e.target.classList.contains('modal')) { e.target.style.display = 'none'; }
            if (window.innerWidth <= 768 && sidebar.classList.contains('show') && !sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
                sidebar.classList.remove('show');
            }
        });

        function initializeApp() {
            if (sessionStorage.getItem('flordeMariaLoggedIn') === 'true') {
                showMainApp();
            } else {
                showLoginScreen();
            }
            document.body.classList.remove('loading');
        }

        initializeApp();
    });
    </script>
</body>
</html>
