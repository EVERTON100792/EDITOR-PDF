<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Integrado | Flor de Maira</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            /* Light Theme Defaults */
            --primary-color: #0d9488; /* Teal 600 */
            --primary-dark-color: #0f766e; /* Teal 700 */
            --primary-light-color: #f0fdfa; /* Teal 50 */
            
            --text-primary: #1e293b; /* Slate 800 */
            --text-secondary: #64748b; /* Slate 500 */
            
            --bg-color: #f8fafc; /* Slate 50 */
            --surface-color: #ffffff;
            --border-color: #e2e8f0; /* Slate 200 */
            --shadow-color: rgba(0,0,0,0.05);

            --success-color: #22c55e;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
        }

        /* Dark Theme */
        body.dark-theme {
            --primary-color: #2dd4bf; /* Teal 400 */
            --primary-dark-color: #14b8a6; /* Teal 500 */
            --primary-light-color: #134e4a; /* Teal 900 */
            
            --text-primary: #e2e8f0; /* Slate 200 */
            --text-secondary: #94a3b8; /* Slate 400 */
            
            --bg-color: #1a202c; /* Darker Slate */
            --surface-color: #2d3748; /* Even Darker Slate */
            --border-color: #4a5568; /* Gray 600 */
            --shadow-color: rgba(0,0,0,0.3);

            --success-color: #4ade80; /* Lighter Green */
            --danger-color: #f87171; /* Lighter Red */
            --warning-color: #fbbf24; /* Lighter Orange */
            --info-color: #60a5fa; /* Lighter Blue */
        }

        /* --- BASE STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body {
            height: 100%;
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            background-color: var(--bg-color);
            -webkit-font-smoothing: antialiased;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* --- UTILITY CLASSES --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .justify-center { justify-content: center; }
        .items-center { align-items: center; }
        .gap-2 { gap: 1rem; }
        .gap-4 { gap: 2rem; }
        .align-items-end { align-items: flex-end; }
        .flex-1 { flex: 1; }
        .mt-3 { margin-top: 1.5rem; }
        .mt-4 { margin-top: 2rem; }
        .mb-2 { margin-bottom: 1rem; }
        .p-4 { padding: 1rem; }
        .text-center { text-align: center; }
        .rounded-lg { border-radius: 0.5rem; }
        .shadow-md { box-shadow: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -2px var(--shadow-color); }
        .shadow-lg { box-shadow: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -4px var(--shadow-color); }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            background: var(--primary-light-color);
            display: flex; justify-content: center; align-items: center;
            height: 100%; padding: 1rem;
        }
        .login-box {
            background-color: var(--surface-color); padding: 40px; border-radius: 12px;
            box-shadow: var(--shadow-lg);
            text-align: center; width: 100%; max-width: 400px;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .login-box h1 { font-size: 2.5rem; font-weight: 700; color: var(--primary-color); margin-bottom: 10px;}
        .login-box .subtitle { color: var(--text-secondary); margin-bottom: 35px; font-size: 1rem; }
        .input-group { position: relative; margin-bottom: 35px; }
        .input-group input {
            width: 100%; padding: 10px 5px; border: none; border-bottom: 2px solid var(--border-color);
            background-color: transparent; font-size: 1rem; position: relative; z-index: 1; transition: border-color 0.3s, background-color 0.3s;
            color: var(--text-primary);
        }
        .input-group label { position: absolute; left: 5px; top: 10px; color: var(--text-secondary); pointer-events: none; transition: all 0.3s ease; }
        .input-group input:focus { outline: none; border-bottom-color: var(--primary-color); }
        .input-group input:focus ~ label, .input-group input:valid ~ label {
            transform: translateY(-24px); font-size: 0.8rem; color: var(--primary-color);
        }
        .btn-login {
            width: 100%; padding: 14px; border: none; border-radius: 8px;
            background: var(--primary-color); color: white; font-size: 1.1rem;
            font-weight: 600; cursor: pointer; transition: background 0.3s ease, transform 0.2s;
        }
        .btn-login:hover { background: var(--primary-dark-color); transform: translateY(-2px); }
        .btn-login:active { transform: translateY(0); }
        .error-message { color: var(--danger-color); margin-top: 15px; height: 20px; font-size: 0.9rem; font-weight: 500; }

        /* --- DASHBOARD LAYOUT --- */
        #dashboard-screen { display: flex; height: 100vh; background-color: var(--bg-color); }
        
        .sidebar {
            width: 260px; background: var(--surface-color); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; padding: 20px 15px;
            flex-shrink: 0; transition: transform 0.3s ease-in-out, background-color 0.3s ease, border-color 0.3s ease;
            z-index: 1000;
        }
        .sidebar-header { text-align: center; margin-bottom: 30px; }
        .sidebar-header h2 { color: var(--primary-color); font-weight: 700; font-size: 1.8rem; }
        .sidebar-nav ul { list-style: none; padding: 0; }
        .sidebar-nav li a {
            display: flex; align-items: center; gap: 12px; padding: 12px 15px;
            color: var(--text-secondary); text-decoration: none; border-radius: 8px;
            margin-bottom: 6px; transition: all 0.2s ease; font-weight: 500; font-size: 0.95rem;
        }
        .sidebar-nav li a .icon { width: 20px; height: 20px; stroke-width: 2; }
        .sidebar-nav li a:hover { background-color: var(--primary-light-color); color: var(--primary-dark-color); transform: translateX(5px); }
        .sidebar-nav li a.active { background-color: var(--primary-color); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .sidebar-footer { margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .logout-btn {
            display: flex; align-items: center; justify-content: center; gap: 12px;
            width: 100%; padding: 12px; border: 1px solid var(--border-color);
            background: transparent; color: var(--text-secondary); border-radius: 8px;
            cursor: pointer; font-size: 1rem; font-weight: 500; transition: all 0.2s ease;
        }
        .logout-btn:hover { background-color: var(--danger-color); color: white; border-color: var(--danger-color); transform: translateY(-2px); }
        .logout-btn:active { transform: translateY(0); }
        
        .main-content { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .main-header { 
            display: flex; align-items: center; justify-content: space-between; 
            margin-bottom: 30px; 
            background-color: var(--surface-color);
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
        }
        .mobile-header { display: none; align-items: center; gap: 15px; }
        #menu-toggle { background: none; border: none; cursor: pointer; padding: 0.5rem; }
        #menu-toggle .bar { display: block; width: 25px; height: 3px; background-color: var(--text-primary); margin: 5px 0; transition: 0.4s; border-radius: 2px; }
        
        .theme-toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .theme-toggle {
            position: relative;
            display: inline-block;
            width: 45px;
            height: 25px;
        }
        .theme-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--text-secondary);
            transition: .4s;
            border-radius: 25px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 17px;
            width: 17px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        .theme-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .main-content h1 { font-size: 2rem; color: var(--text-primary); font-weight: 700; }

        /* --- CONTENT SECTIONS --- */
        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CARD STYLES --- */
        .card { 
            background: var(--surface-color); padding: 25px; border-radius: 12px; 
            margin-top: 20px; border: 1px solid var(--border-color); 
            box-shadow: var(--shadow-md);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .card h2 { margin-bottom: 20px; color: var(--text-primary); font-weight: 700; font-size: 1.5rem; }
        .card h3 { font-weight: 600; color: var(--text-primary); }

        /* --- FORM STYLES --- */
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); font-size: 0.9rem; }
        .form-group input, .form-group select {
            width: 100%; padding: 12px 15px; border: 1px solid var(--border-color);
            border-radius: 8px; font-size: 1rem; font-family: 'Inter', sans-serif;
            background-color: var(--surface-color); color: var(--text-primary);
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light-color);
        }
        .form-actions {
            margin-top: 1.5rem;
            display: flex;
            gap: 10px;
        }

        /* --- BUTTON STYLES --- */
        .btn, .btn-submit {
            padding: 12px 25px; border: none; border-radius: 8px; background: var(--primary-color);
            color: white; font-size: 1rem; cursor: pointer; transition: background 0.2s, transform 0.2s; font-weight: 600;
        }
        .btn:hover, .btn-submit:hover { background: var(--primary-dark-color); transform: translateY(-2px); }
        .btn:active, .btn-submit:active { transform: translateY(0); }
        .btn-secondary {
            background-color: var(--text-secondary);
        }
        .btn-secondary:hover {
            background-color: #5a6a7c; /* slightly darker slate */
        }
        
        /* --- TABLE STYLES --- */
        .table-responsive-container { overflow-x: auto; margin-top: 20px;}
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th, td { 
            padding: 15px 20px; text-align: left; 
            border-bottom: 1px solid var(--border-color);
        }
        th { 
            background-color: var(--primary-light-color); font-weight: 600; color: var(--primary-dark-color); 
            font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px;
            position: sticky; top: 0;
        }
        body.dark-theme th {
            background-color: var(--primary-dark-color);
            color: var(--primary-light-color);
        }
        td { color: var(--text-primary); font-size: 0.95rem; }
        tr:nth-child(even) { background-color: rgba(0,0,0,0.02); }
        body.dark-theme tr:nth-child(even) { background-color: rgba(255,255,255,0.03); }

        .btn-action { padding: 8px 12px; border-radius: 6px; color: white; font-weight: 500; border: none; cursor: pointer; margin-right: 8px; transition: background-color 0.2s, transform 0.2s;}
        .btn-action:hover { transform: translateY(-1px); }
        .btn-action:active { transform: translateY(0); }
        .btn-paid { background-color: var(--success-color); }
        .btn-paid:hover { background-color: #1a964f; }
        .btn-edit { background-color: var(--info-color); }
        .btn-edit:hover { background-color: #3174d8; }
        .btn-delete { background-color: var(--danger-color); }
        .btn-delete:hover { background-color: #cc3939; }
        .status-pendente { color: var(--warning-color); font-weight: bold; }
        .status-pago { color: var(--success-color); font-weight: bold; }
        .valor-entrada { color: var(--success-color); font-weight: 600; }
        .valor-saida { color: var(--danger-color); font-weight: 600; }
        
        /* --- DASHBOARD SPECIFIC --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
        .summary-card { 
            padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);
            background-color: var(--surface-color); box-shadow: var(--shadow-md);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .summary-card h3 { font-size: 0.95rem; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .summary-card p { font-size: 2rem; font-weight: 700; color: var(--text-primary); }
        
        .dashboard-main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 20px; }
        #sales-summary-container .summary-card { 
            padding: 15px; 
            margin-bottom: 1rem; 
            box-shadow: none;
            border: 1px dashed var(--border-color); /* Lighter border for inner cards */
        }
        #sales-summary-container .summary-card:last-child {
            margin-bottom: 0;
        }
        #sales-summary-container .summary-card p { font-size: 1.5rem; }

        /* --- SETTINGS SPECIFIC --- */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .settings-card {
            background: var(--surface-color);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
        }
        .settings-card h3 {
            margin-bottom: 15px;
            font-size: 1.25rem;
            color: var(--text-primary);
        }
        .settings-card .btn {
            width: 100%;
            margin-top: 15px;
        }
        #backup-file-input {
            margin-top: 10px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-color);
            color: var(--text-primary);
        }


        /* --- MEDIA QUERIES --- */
        @media (max-width: 1024px) {
            .dashboard-main-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .sidebar { 
                position: fixed; height: 100%; width: 240px; 
                transform: translateX(-100%); 
                box-shadow: 0 10px 15px -3px var(--shadow-color); 
                border-right: none;
            }
            .sidebar.open { transform: translateX(0); }
            .main-content { padding: 20px; }
            .main-header { justify-content: flex-start; padding: 15px; }
            .mobile-header { display: flex; }
            .desktop-title { display: none; }
            .dashboard-grid { grid-template-columns: 1fr 1fr; }
            .flex.gap-2 { flex-direction: column; gap: 0.5rem; } /* Adjust flex for small screens */
            .align-items-end { align-items: stretch; }
            .align-items-end .btn { margin-top: 0.5rem; }
            .form-actions { flex-direction: column; }
            .btn, .btn-submit { width: 100%; }
        }
        @media (max-width: 480px) {
             .dashboard-grid { grid-template-columns: 1fr; }
             .login-box { padding: 30px 20px; }
             .login-box h1 { font-size: 2rem; }
             .input-group { margin-bottom: 25px; }
             .main-content { padding: 15px; }
             .card { padding: 15px; }
             .card h2 { font-size: 1.3rem; margin-bottom: 15px; }
             th, td { padding: 10px 12px; font-size: 0.9rem; }
             .btn-action { padding: 6px 10px; margin-right: 3px;}
             .settings-grid { grid-template-columns: 1fr; }
        }

    </style>
</head>
<body>
    <div id="login-screen" class="hidden">
        <div class="login-box">
            <h1>Flor de Maira</h1>
            <p class="subtitle">Acesse seu painel de gestão</p>
            <form id="login-form">
                <div class="input-group">
                    <input type="text" id="username" required>
                    <label for="username">Usuário</label>
                </div>
                <div class="input-group">
                    <input type="password" id="password" required>
                    <label for="password">Senha</label>
                </div>
                <button type="submit" class="btn-login">Entrar</button>
                <p id="error-message" class="error-message"></p>
            </form>
        </div>
    </div>

    <div id="dashboard-screen" class="hidden">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header"><h2>Flor de Maira</h2></div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="#dashboard" class="nav-link active" data-target="dashboard-view"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg><span>Dashboard</span></a></li>
                    <li><a href="#caixa" class="nav-link" data-target="caixa-view"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><span>Fluxo de Caixa</span></a></li>
                    <li><a href="#vendas" class="nav-link" data-target="vendas-view"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><span>Realizar Venda</span></a></li>
                    <li><a href="#clientes" class="nav-link" data-target="clientes-view"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><span>Clientes</span></a></li>
                    <li><a href="#estoque" class="nav-link" data-target="estoque-view"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg><span>Estoque</span></a></li>
                    <li><a href="#contas-a-receber" class="nav-link" data-target="contas-a-receber-view"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1h4a2 2 0 012 2v11a2 2 0 01-2 2H8a2 2 0 01-2-2V8a2 2 0 012-2h4z"></path></svg><span>Contas a Receber</span></a></li>
                    <li><a href="#relatorios" class="nav-link" data-target="relatorios-view"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span>Relatórios</span></a></li>
                    <li><a href="#configuracoes" class="nav-link" data-target="configuracoes-view"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.294.542 2.573-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg><span>Configurações</span></a></li>
                </ul>
            </nav>
            <div class="sidebar-footer"><button class="logout-btn" id="logout-btn"><svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg><span>Sair</span></button></div>
        </aside>

        <main class="main-content" id="main-content">
            <header class="main-header">
                <div class="mobile-header">
                    <button id="menu-toggle"><span class="bar"></span><span class="bar"></span><span class="bar"></span></button>
                    <h1 id="mobile-page-title"></h1>
                </div>
                <h1 class="desktop-title" id="desktop-page-title"></h1>
                <div class="theme-toggle-container">
                    <span class="theme-label">Claro</span>
                    <label class="theme-toggle">
                        <input type="checkbox" id="theme-switcher">
                        <span class="slider"></span>
                    </label>
                    <span class="theme-label">Escuro</span>
                </div>
            </header>
            
            <section id="dashboard-view" class="content-section">
                <div class="dashboard-grid">
                    <div class="summary-card"><h3 style="color:var(--success-color);">Saldo em Caixa</h3><p id="saldo-caixa-dashboard">R$ 0,00</p></div>
                    <div class="summary-card"><h3 style="color:var(--warning-color);">Total a Receber</h3><p id="total-a-receber-dashboard">R$ 0,00</p></div>
                </div>
                <div class="dashboard-main-grid">
                    <div class="card"><h2>Vendas por Método de Pagamento</h2><div style="height:300px;"><canvas id="paymentMethodChart"></canvas></div></div>
                    <div class="card"><h2>Resumo de Vendas</h2><div id="sales-summary-container"></div></div>
                </div>
            </section>
            
            <section id="caixa-view" class="content-section">
                <div class="card"><h2>Saldo Atual: <span id="saldo-caixa-detalhe" style="color: var(--primary-color);">R$ 0,00</span></h2></div>
                <div class="card">
                    <h2>Adicionar Lançamento Manual</h2>
                    <form id="form-add-lancamento">
                        <input type="hidden" id="lancamento-id">
                        <div class="flex gap-2">
                            <div class="form-group flex-1">
                                <label for="desc-lancamento">Descrição</label>
                                <input type="text" id="desc-lancamento" required>
                            </div>
                            <div class="form-group">
                                <label for="valor-lancamento">Valor (R$)</label>
                                <input type="number" step="0.01" id="valor-lancamento" required min="0.01">
                            </div>
                            <div class="form-group">
                                <label for="tipo-lancamento">Tipo</label>
                                <select id="tipo-lancamento">
                                    <option value="Entrada">Entrada</option>
                                    <option value="Saída">Saída</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn-submit" id="btn-salvar-lancamento">Lançar</button>
                            <button type="button" class="btn btn-secondary" id="btn-cancelar-lancamento" style="display:none;">Cancelar Edição</button>
                        </div>
                    </form>
                </div>
                <div class="card"><h2>Histórico de Movimentações</h2><div id="tabela-caixa-container" class="table-responsive-container"></div></div>
            </section>

            <section id="clientes-view" class="content-section">
                <div class="card">
                    <h2>Cadastrar/Editar Cliente</h2>
                    <form id="form-add-cliente">
                        <input type="hidden" id="cliente-id">
                        <div class="form-group">
                            <label for="nome-cliente">Nome</label>
                            <input type="text" id="nome-cliente" required>
                        </div>
                        <div class="form-group">
                            <label for="contato-cliente">Telefone ou E-mail</label>
                            <input type="text" id="contato-cliente">
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn-submit" id="btn-salvar-cliente">Salvar Cliente</button>
                            <button type="button" class="btn btn-secondary" id="btn-cancelar-cliente" style="display:none;">Cancelar Edição</button>
                        </div>
                    </form>
                </div>
                <div class="card"><h2>Clientes Cadastrados</h2><div id="tabela-clientes-container" class="table-responsive-container"></div></div>
            </section>

            <section id="estoque-view" class="content-section">
                <div class="card">
                    <h2>Cadastrar/Editar Produto</h2>
                    <form id="form-add-produto">
                        <input type="hidden" id="produto-id">
                        <div class="flex gap-2">
                            <div class="form-group flex-1">
                                <label for="nome-produto">Nome do Produto</label>
                                <input type="text" id="nome-produto" required>
                            </div>
                            <div class="form-group">
                                <label for="qtd-produto">Quantidade</label>
                                <input type="number" id="qtd-produto" required min="0">
                            </div>
                            <div class="form-group flex-1">
                                <label for="preco-produto">Preço (R$)</label>
                                <input type="number" step="0.01" id="preco-produto" required min="0.01">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn-submit" id="btn-salvar-produto">Adicionar/Atualizar Produto</button>
                            <button type="button" class="btn btn-secondary" id="btn-cancelar-produto" style="display:none;">Cancelar Edição</button>
                        </div>
                    </form>
                </div>
                <div class="card">
                    <h2>Atualizar Estoque Manualmente</h2>
                    <form id="form-update-stock">
                        <div class="flex gap-2 align-items-end">
                            <div class="form-group flex-1">
                                <label for="update-stock-product">Produto</label>
                                <select id="update-stock-product" required>
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="update-stock-quantity">Quantidade</label>
                                <input type="number" id="update-stock-quantity" required value="1" min="1">
                            </div>
                            <div class="form-group">
                                <label for="update-stock-type">Tipo</label>
                                <select id="update-stock-type" required>
                                    <option value="add">Adicionar</option>
                                    <option value="remove">Remover</option>
                                </select>
                            </div>
                            <button type="submit" class="btn">Atualizar</button>
                        </div>
                    </form>
                </div>
                <div class="card"><h2>Produtos em Estoque</h2><div id="tabela-produtos-container" class="table-responsive-container"></div></div>
            </section>

            <section id="vendas-view" class="content-section">
                <div class="card" id="venda-form-card">
                    <form id="venda-form">
                        <div class="form-group"><label for="venda-cliente">Selecione o Cliente</label><select id="venda-cliente" required></select></div>
                        <div class="card mt-3"><h3 style="font-weight:600; color:var(--text-primary); margin-bottom: 1rem;">Adicionar Item</h3><div class="flex gap-2 align-items-end"><div class="form-group flex-1"><label for="venda-produto">Produto</label><select id="venda-produto"></select></div><div class="form-group"><label for="venda-qtd">Qtd.</label><input type="number" id="venda-qtd" value="1" min="1" style="width: 80px;"></div><button type="button" id="btn-add-item-venda" class="btn">Adicionar</button></div></div>
                        <div class="card mt-3"><h3>Itens da Venda</h3><div id="venda-itens-container" class="table-responsive-container"></div><h3 style="margin-top:1rem; text-align:right; font-weight:700; font-size:1.125rem;">Total: <span id="venda-total">R$ 0,00</span></h3></div>
                        <div class="card mt-3"><h3>Pagamento</h3><div class="form-group"><label for="venda-pagamento">Método</label><select id="venda-pagamento"><option value="vista">À Vista</option><option value="pix">Pix</option><option value="fiado">Fiado</option><option value="parcelado">Parcelado</option></select></div><div class="form-group hidden" id="venda-parcelas-group"><label for="venda-parcelas">Parcelas</label><select id="venda-parcelas"><option value="2">2x</option><option value="3">3x</option><option value="4">4x</option><option value="5">5x</option><option value="6">6x</option><option value="7">7x</option><option value="8">8x</option><option value="9">9x</option><option value="10">10x</option><option value="11">11x</option><option value="12">12x</option></select></div></div>
                        <button type="button" id="btn-finalizar-venda" class="btn-submit" style="margin-top:1.5rem; width:100%;">Finalizar Venda</button>
                    </form>
                </div>
            </section>
            
            <section id="contas-a-receber-view" class="content-section">
                <div class="card"><h2>Contas a Receber</h2><div id="tabela-contas-container" class="table-responsive-container"></div></div>
            </section>
            
            <section id="relatorios-view" class="content-section">
                <div class="card">
                    <h2>Gerar Relatório de Vendas</h2>
                    <div class="flex gap-2 align-items-end">
                        <div class="form-group flex-1">
                            <label for="relatorio-inicio">Data Início</label>
                            <input type="date" id="relatorio-inicio">
                        </div>
                        <div class="form-group flex-1">
                            <label for="relatorio-fim">Data Fim</label>
                            <input type="date" id="relatorio-fim">
                        </div>
                        <button id="btn-gerar-relatorio" class="btn">Gerar Relatório</button>
                    </div>
                </div>
                <div id="relatorio-container" class="card mt-3 hidden">
                    <h2>Resultados do Relatório</h2>
                    <p>Período: <span id="relatorio-periodo"></span></p>
                    <p>Total de Vendas: <span id="relatorio-total-vendas">R$ 0,00</span></p>
                    <p>Total de Itens Vendidos: <span id="relatorio-total-itens">0</span></p>
                    <h3 style="margin-top:1.5rem;">Vendas por Método de Pagamento:</h3>
                    <ul id="relatorio-metodo-pagamento"></ul>
                </div>
            </section>

            <section id="configuracoes-view" class="content-section">
                <div class="settings-grid">
                    <div class="settings-card">
                        <h3>Configurações de Tema</h3>
                        <div class="theme-toggle-container justify-center">
                            <span class="theme-label">Claro</span>
                            <label class="theme-toggle">
                                <input type="checkbox" id="theme-switcher-settings">
                                <span class="slider"></span>
                            </label>
                            <span class="theme-label">Escuro</span>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h3>Backup e Restauração</h3>
                        <button id="btn-backup-data" class="btn">Fazer Backup</button>
                        <hr class="mt-3 mb-2" style="border-color: var(--border-color);">
                        <label for="backup-file-input" class="form-group">Restaurar de Backup:</label>
                        <input type="file" id="backup-file-input" accept=".json">
                        <button id="btn-restore-data" class="btn btn-secondary mt-3">Restaurar Backup</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- SELETORES GERAIS ---
        const loginScreen = document.getElementById('login-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const mainContent = document.getElementById('main-content');
        const sidebar = document.getElementById('sidebar');
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const navLinks = document.querySelectorAll('.nav-link');
        const contentSections = document.querySelectorAll('.content-section');
        const menuToggle = document.getElementById('menu-toggle');
        const mobilePageTitle = document.getElementById('mobile-page-title');
        const desktopPageTitle = document.getElementById('desktop-page-title');
        const themeSwitcherMain = document.getElementById('theme-switcher');
        const themeSwitcherSettings = document.getElementById('theme-switcher-settings');

        // --- ESTADO DA APLICAÇÃO ---
        let clientes = [], produtos = [], vendas = [], contasAReceber = [], fluxoCaixa = [];
        let carrinhoVenda = [];
        let paymentChartInstance = null;

        // --- FUNÇÕES DE DADOS E UTILITÁRIAS ---
        const saveData = (key, data) => localStorage.setItem(key, JSON.stringify(data));
        const loadData = (key) => JSON.parse(localStorage.getItem(key)) || [];
        const formatCurrency = (value) => (typeof value === 'number' ? value : 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            const date = new Date(dateString + 'T00:00:00'); // Ensure UTC to avoid timezone issues
            return date.toLocaleDateString('pt-BR');
        };
        
        const showNotification = (message, isError = false) => {
            const notification = document.createElement('div');
            Object.assign(notification.style, {
                position: 'fixed', bottom: '20px', right: '20px', padding: '15px 25px', borderRadius: '8px',
                color: 'white', zIndex: '2000', opacity: '0', transition: 'all 0.4s ease',
                transform: 'translateY(10px)', boxShadow: '0 10px 15px -3px rgba(0,0,0,0.1)',
                backgroundColor: isError ? 'var(--danger-color)' : 'var(--success-color)', fontWeight: '500'
            });
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => { notification.style.opacity = '1'; notification.style.transform = 'translateY(0)'; }, 10);
            setTimeout(() => { notification.style.opacity = '0'; notification.style.transform = 'translateY(10px)'; setTimeout(() => notification.remove(), 500); }, 3500);
        };

        // --- THEME LOGIC ---
        const applyTheme = (theme) => {
            document.body.classList.toggle('dark-theme', theme === 'dark');
            localStorage.setItem('theme', theme);
            themeSwitcherMain.checked = theme === 'dark';
            themeSwitcherSettings.checked = theme === 'dark';
        };

        const loadTheme = () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                applyTheme(savedTheme);
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                applyTheme('dark');
            } else {
                applyTheme('light');
            }
        };

        // --- FUNÇÕES DE RENDERIZAÇÃO ---
        const renderTable = (containerId, headers, data, renderRow) => {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = ''; // Clear previous content
            if (data.length === 0) {
                container.innerHTML = '<p style="text-align:center; padding: 20px; color: var(--text-secondary);">Nenhum registro encontrado.</p>';
            } else {
                const table = document.createElement('table');
                table.innerHTML = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${data.map(renderRow).join('')}</tbody>`;
                container.appendChild(table);
            }
        };

        const navigateToPage = (pageId) => {
            if (!pageId || !document.getElementById(pageId)) {
                pageId = 'dashboard-view'; // Default to dashboard
            }
            
            contentSections.forEach(s => s.classList.remove('active'));
            navLinks.forEach(l => l.classList.remove('active'));

            document.getElementById(pageId).classList.add('active');
            const targetLink = document.querySelector(`.nav-link[data-target="${pageId}"]`);
            if (targetLink) {
                targetLink.classList.add('active');
                const pageName = targetLink.querySelector('span').textContent;
                desktopPageTitle.textContent = pageName;
                mobilePageTitle.textContent = pageName;
            }

            localStorage.setItem('lastActivePage', pageId);

            // Calls the specific rendering function for the activated page
            if (pageId === 'dashboard-view') renderDashboardSummaries();
            if (pageId === 'caixa-view') renderFluxoCaixa();
            if (pageId === 'vendas-view') { popularFormulariosVenda(); renderCarrinho(); }
            if (pageId === 'clientes-view') renderClientes();
            if (pageId === 'estoque-view') { renderProdutos(); populateUpdateStockProductSelect(); }
            if (pageId === 'contas-a-receber-view') renderContasAReceber();
            if (pageId === 'relatorios-view') document.getElementById('relatorio-container').classList.add('hidden'); // Hide report results on page load
        };
        
        const renderDashboardSummaries = () => {
            const saldoCaixaEl = document.getElementById('saldo-caixa-dashboard');
            if (!saldoCaixaEl) return; 

            saldoCaixaEl.textContent = formatCurrency(fluxoCaixa.reduce((acc, item) => acc + (item.tipo === 'Entrada' ? item.valor : -item.valor), 0));
            document.getElementById('total-a-receber-dashboard').textContent = formatCurrency(contasAReceber.filter(c => c.status === 'Pendente').reduce((acc, c) => acc + c.valor, 0));

            const salesSummary = vendas.reduce((acc, venda) => {
                acc[venda.metodoPagamento] = (acc[venda.metodoPagamento] || 0) + venda.total;
                return acc;
            }, { vista: 0, pix: 0, fiado: 0, parcelado: 0 });

            const summaryContainer = document.getElementById('sales-summary-container');
            if (summaryContainer) {
                summaryContainer.innerHTML = `
                    <div class="summary-card" style="border-left: 4px solid var(--success-color); margin-bottom: 1rem;"><h3 style="font-weight:500; color:var(--text-secondary);">À Vista</h3><p>${formatCurrency(salesSummary.vista)}</p></div>
                    <div class="summary-card" style="border-left: 4px solid var(--info-color); margin-bottom: 1rem;"><h3 style="font-weight:500; color:var(--text-secondary);">Pix</h3><p>${formatCurrency(salesSummary.pix)}</p></div>
                    <div class="summary-card" style="border-left: 4px solid var(--warning-color); margin-bottom: 1rem;"><h3 style="font-weight:500; color:var(--text-secondary);">Fiado</h3><p>${formatCurrency(salesSummary.fiado)}</p></div>
                    <div class="summary-card" style="border-left: 4px solid var(--danger-color);"><h3 style="font-weight:500; color:var(--text-secondary);">Parcelado</h3><p>${formatCurrency(salesSummary.parcelado)}</p></div>
                `;
            }
            renderPaymentChart(salesSummary);
        };
        
        const renderPaymentChart = (salesSummary) => {
            const ctx = document.getElementById('paymentMethodChart');
            if (!ctx) return; 

            if(paymentChartInstance) paymentChartInstance.destroy();

            paymentChartInstance = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['À Vista', 'Pix', 'Fiado', 'Parcelado'],
                    datasets: [{
                        label: 'Total de Vendas',
                        data: [ salesSummary.vista, salesSummary.pix, salesSummary.fiado, salesSummary.parcelado ],
                        backgroundColor: [ 'var(--success-color)', 'var(--info-color)', 'var(--warning-color)', 'var(--danger-color)' ],
                        borderColor: [ 'var(--success-color)', 'var(--info-color)', 'var(--warning-color)', 'var(--danger-color)' ],
                        borderWidth: 1, borderRadius: 4,
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `${c.label}: ${formatCurrency(c.raw)}` } } },
                    scales: { 
                        x: { 
                            beginAtZero: true, 
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { color: 'var(--text-secondary)' }
                        }, 
                        y: { 
                            grid: { display: false },
                            ticks: { color: 'var(--text-secondary)' }
                        } 
                    }
                }
            });
        };

        const renderFluxoCaixa = () => {
            const saldoEl = document.getElementById('saldo-caixa-detalhe');
            if (!saldoEl) return;
            saldoEl.textContent = formatCurrency(fluxoCaixa.reduce((acc, item) => acc + (item.tipo === 'Entrada' ? item.valor : -item.valor), 0));
            renderTable('tabela-caixa-container', ['Data', 'Descrição', 'Tipo', 'Valor', 'Ações'], fluxoCaixa.sort((a,b) => new Date(b.data) - new Date(a.data)), item => `
                <tr>
                    <td>${formatDate(item.data)}</td>
                    <td>${item.descricao}</td>
                    <td><span class="valor-${item.tipo.toLowerCase()}">${item.tipo}</span></td>
                    <td><span class="valor-${item.tipo.toLowerCase()}">${item.tipo === 'Entrada' ? '+' : '-'} ${formatCurrency(item.valor)}</span></td>
                    <td>
                        <button class="btn-action btn-edit" data-id="${item.id}" data-type="lancamento">Editar</button>
                        <button class="btn-action btn-delete" data-id="${item.id}" data-type="lancamento">Excluir</button>
                    </td>
                </tr>`);
                resetForm('form-add-lancamento', 'lancamento');
        };

        const renderClientes = () => {
            renderTable('tabela-clientes-container', ['Nome', 'Contato', 'Ações'], clientes, c => `
                <tr>
                    <td>${c.nome}</td>
                    <td>${c.contato || 'N/A'}</td>
                    <td>
                        <button class="btn-action btn-edit" data-id="${c.id}" data-type="cliente">Editar</button>
                        <button class="btn-action btn-delete" data-id="${c.id}" data-type="cliente">Excluir</button>
                    </td>
                </tr>`);
            resetForm('form-add-cliente', 'cliente');
        }

        const renderProdutos = () => {
            renderTable('tabela-produtos-container', ['Produto', 'Qtd. em Estoque', 'Preço', 'Ações'], produtos, p => `
                <tr>
                    <td>${p.nome}</td>
                    <td>${p.quantidade}</td>
                    <td>${formatCurrency(p.preco)}</td>
                    <td>
                        <button class="btn-action btn-edit" data-id="${p.id}" data-type="produto">Editar</button>
                        <button class="btn-action btn-delete" data-id="${p.id}" data-type="produto">Excluir</button>
                    </td>
                </tr>`);
            resetForm('form-add-produto', 'produto');
        };

        const renderContasAReceber = () => {
            const getNomeCliente = id => clientes.find(c => c.id === id)?.nome || 'Cliente avulso';
            renderTable('tabela-contas-container', ['Cliente', 'Valor', 'Vencimento', 'Status', 'Ação'], contasAReceber.sort((a,b) => new Date(a.dataVencimento) - new Date(b.dataVencimento)), conta => `
                <tr>
                    <td>${getNomeCliente(conta.clienteId)}</td>
                    <td>${formatCurrency(conta.valor)}</td>
                    <td>${formatDate(conta.dataVencimento)}</td>
                    <td><span class="status-${conta.status.toLowerCase()}">${conta.status}</span></td>
                    <td>${conta.status === 'Pendente' ? `<button class="btn-action btn-paid" data-id="${conta.id}">Dar Baixa</button>` : 'Recebido'}</td>
                </tr>`);
        };

        const popularFormulariosVenda = () => {
            const clienteSelect = document.getElementById('venda-cliente');
            const produtoSelect = document.getElementById('venda-produto');

            if(clienteSelect) {
                clienteSelect.innerHTML = '<option value="">Selecione...</option>' + clientes.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
            }
            if(produtoSelect) {
                produtoSelect.innerHTML = '<option value="">Selecione...</option>' + produtos.filter(p => p.quantidade > 0).map(p => `<option value="${p.id}">${p.nome} (${p.quantidade} disp.)</option>`).join('');
            }
        };

        const populateUpdateStockProductSelect = () => {
            const updateStockProductSelect = document.getElementById('update-stock-product');
            if (updateStockProductSelect) {
                updateStockProductSelect.innerHTML = '<option value="">Selecione...</option>' + produtos.map(p => `<option value="${p.id}">${p.nome} (Estoque: ${p.quantidade})</option>`).join('');
            }
        };

        const renderCarrinho = () => {
            const totalEl = document.getElementById('venda-total');
            if (!totalEl) return;
            renderTable('venda-itens-container', ['Produto', 'Qtd', 'Subtotal', 'Ação'], carrinhoVenda, item => `
                <tr>
                    <td>${item.nome}</td>
                    <td>${item.quantidade}</td>
                    <td>${formatCurrency(item.subtotal)}</td>
                    <td><button class="btn-action btn-delete" data-id="${item.produtoId}">Remover</button></td>
                </tr>`);
            totalEl.textContent = formatCurrency(carrinhoVenda.reduce((acc, item) => acc + item.subtotal, 0));
        };
        
        const addItemAoCarrinho = () => {
            const produtoId = document.getElementById('venda-produto').value;
            const quantidadeInput = document.getElementById('venda-qtd');
            const quantidade = parseInt(quantidadeInput.value);

            if (!produtoId || isNaN(quantidade) || quantidade <= 0) { 
                showNotification('Selecione um produto e uma quantidade válida.', true); 
                return; 
            }
            const produto = produtos.find(p => p.id == produtoId);
            if (!produto) { showNotification('Produto não encontrado.', true); return; }

            const itemExistente = carrinhoVenda.find(item => item.produtoId == produtoId);
            const qtdNoCarrinho = itemExistente ? itemExistente.quantidade : 0;

            if (quantidade + qtdNoCarrinho > produto.quantidade) { 
                showNotification(`Quantidade insuficiente em estoque! Disponível: ${produto.quantidade - qtdNoCarrinho}`, true); 
                return; 
            }

            if (itemExistente) {
                itemExistente.quantidade += quantidade;
                itemExistente.subtotal = itemExistente.quantidade * produto.preco;
            } else {
                carrinhoVenda.push({ produtoId: produto.id, nome: produto.nome, quantidade, precoUnitario: produto.preco, subtotal: quantidade * produto.preco });
            }
            renderCarrinho();
            showNotification('Item adicionado ao carrinho.');
            quantidadeInput.value = 1; // Reset quantity input
        };

        const finalizarVenda = () => {
            const clienteId = document.getElementById('venda-cliente').value;
            if (!clienteId || carrinhoVenda.length === 0) { showNotification('Selecione um cliente e adicione itens!', true); return; }
            
            const total = carrinhoVenda.reduce((acc, item) => acc + item.subtotal, 0);
            const metodoPagamento = document.getElementById('venda-pagamento').value;
            
            const novaVenda = { 
                id: Date.now(), 
                clienteId: parseInt(clienteId), 
                itens: [...carrinhoVenda], 
                total, 
                metodoPagamento, 
                data: new Date().toISOString().split('T')[0] 
            };
            
            vendas.push(novaVenda);
            
            carrinhoVenda.forEach(item => {
                const produtoEstoque = produtos.find(p => p.id == item.produtoId);
                if(produtoEstoque) produtoEstoque.quantidade -= item.quantidade;
            });
            
            if (metodoPagamento === 'vista' || metodoPagamento === 'pix') {
                const clienteNome = clientes.find(c => c.id === novaVenda.clienteId)?.nome || 'Avulso';
                fluxoCaixa.push({ id: Date.now(), data: new Date().toISOString(), tipo: 'Entrada', descricao: `Venda (${metodoPagamento}) para ${clienteNome}`, valor: novaVenda.total });
            } else if (metodoPagamento === 'fiado' || metodoPagamento === 'parcelado') {
                const parcelas = metodoPagamento === 'fiado' ? 1 : parseInt(document.getElementById('venda-parcelas').value);
                const valorParcela = total / parcelas;
                for (let i = 1; i <= parcelas; i++) {
                    const dataVencimento = new Date();
                    dataVencimento.setMonth(dataVencimento.getMonth() + i);
                    contasAReceber.push({ 
                        id: Date.now() + i, 
                        vendaId: novaVenda.id, 
                        clienteId: novaVenda.clienteId, 
                        valor: valorParcela, 
                        dataVencimento: dataVencimento.toISOString().split('T')[0], 
                        status: 'Pendente' 
                    });
                }
            }
            
            saveData('vendas', vendas); 
            saveData('produtos', produtos); 
            saveData('contasAReceber', contasAReceber); 
            saveData('fluxoCaixa', fluxoCaixa);
            
            showNotification('Venda realizada com sucesso!');
            carrinhoVenda = []; 
            document.getElementById('venda-form').reset();
            document.getElementById('venda-parcelas-group').classList.add('hidden');
            renderCarrinho();
            popularFormulariosVenda();
            populateUpdateStockProductSelect(); // Update stock view after sale
        };

        // --- CRUD HELPER FUNCTIONS ---
        const resetForm = (formId, type) => {
            document.getElementById(formId).reset();
            let idField, submitBtn, cancelBtn;

            if (type === 'cliente') {
                idField = document.getElementById('cliente-id');
                submitBtn = document.getElementById('btn-salvar-cliente');
                cancelBtn = document.getElementById('btn-cancelar-cliente');
            } else if (type === 'produto') {
                idField = document.getElementById('produto-id');
                submitBtn = document.getElementById('btn-salvar-produto');
                cancelBtn = document.getElementById('btn-cancelar-produto');
            } else if (type === 'lancamento') {
                idField = document.getElementById('lancamento-id');
                submitBtn = document.getElementById('btn-salvar-lancamento');
                cancelBtn = document.getElementById('btn-cancelar-lancamento');
            }

            if (idField) idField.value = '';
            if (submitBtn) submitBtn.textContent = (type === 'cliente' ? 'Salvar Cliente' : type === 'produto' ? 'Adicionar/Atualizar Produto' : 'Lançar');
            if (cancelBtn) cancelBtn.style.display = 'none';
        };


        const deleteItem = (id, type) => {
            if (!confirm(`Tem certeza que deseja excluir este ${type}?`)) return;

            let dataArray;
            let saveDataKey;

            switch (type) {
                case 'cliente':
                    dataArray = clientes;
                    saveDataKey = 'clientes';
                    if (vendas.some(v => v.clienteId === id) || contasAReceber.some(c => c.clienteId === id)) {
                        showNotification('Não é possível excluir cliente com vendas ou contas associadas.', true);
                        return;
                    }
                    break;
                case 'produto':
                    dataArray = produtos;
                    saveDataKey = 'produtos';
                    if (vendas.some(v => v.itens.some(item => item.produtoId === id))) {
                        showNotification('Não é possível excluir produto já presente em vendas.', true);
                        return;
                    }
                    break;
                case 'lancamento':
                    dataArray = fluxoCaixa;
                    saveDataKey = 'fluxoCaixa';
                    break;
                default:
                    showNotification('Tipo de item desconhecido para exclusão.', true);
                    return;
            }

            const initialLength = dataArray.length;
            if (type === 'cliente') clientes = clientes.filter(item => item.id !== id);
            else if (type === 'produto') produtos = produtos.filter(item => item.id !== id);
            else if (type === 'lancamento') fluxoCaixa = fluxoCaixa.filter(item => item.id !== id);
            
            if (dataArray.length < initialLength) { // Check if an item was actually removed
                saveData(saveDataKey, type === 'cliente' ? clientes : type === 'produto' ? produtos : fluxoCaixa);
                showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} excluído(a) com sucesso!`);
                // Re-render relevant tables after deletion
                if (type === 'cliente') renderClientes();
                if (type === 'produto') { renderProdutos(); popularFormulariosVenda(); populateUpdateStockProductSelect(); }
                if (type === 'lancamento') renderFluxoCaixa();
                renderDashboardSummaries(); // Refresh dashboard on relevant changes
            } else {
                showNotification(`Não foi possível encontrar o ${type} para exclusão.`, true);
            }
        };

        const editItem = (id, type) => {
            let itemToEdit;
            let formId, idField, submitBtn, cancelBtn;

            if (type === 'cliente') {
                itemToEdit = clientes.find(c => c.id === id);
                formId = 'form-add-cliente';
                idField = document.getElementById('cliente-id');
                submitBtn = document.getElementById('btn-salvar-cliente');
                cancelBtn = document.getElementById('btn-cancelar-cliente');
                if (itemToEdit) {
                    idField.value = itemToEdit.id;
                    document.getElementById('nome-cliente').value = itemToEdit.nome;
                    document.getElementById('contato-cliente').value = itemToEdit.contato;
                    submitBtn.textContent = 'Atualizar Cliente';
                    cancelBtn.style.display = 'inline-block';
                    showNotification('Formulário preenchido para edição de cliente.');
                }
            } else if (type === 'produto') {
                itemToEdit = produtos.find(p => p.id === id);
                formId = 'form-add-produto';
                idField = document.getElementById('produto-id');
                submitBtn = document.getElementById('btn-salvar-produto');
                cancelBtn = document.getElementById('btn-cancelar-produto');
                if (itemToEdit) {
                    idField.value = itemToEdit.id;
                    document.getElementById('nome-produto').value = itemToEdit.nome;
                    document.getElementById('qtd-produto').value = itemToEdit.quantidade;
                    document.getElementById('preco-produto').value = itemToEdit.preco;
                    submitBtn.textContent = 'Atualizar Produto';
                    cancelBtn.style.display = 'inline-block';
                    showNotification('Formulário preenchido para edição de produto.');
                }
            } else if (type === 'lancamento') {
                itemToEdit = fluxoCaixa.find(l => l.id === id);
                formId = 'form-add-lancamento';
                idField = document.getElementById('lancamento-id');
                submitBtn = document.getElementById('btn-salvar-lancamento');
                cancelBtn = document.getElementById('btn-cancelar-lancamento');
                if (itemToEdit) {
                    idField.value = itemToEdit.id;
                    document.getElementById('desc-lancamento').value = itemToEdit.descricao;
                    document.getElementById('valor-lancamento').value = itemToEdit.valor;
                    document.getElementById('tipo-lancamento').value = itemToEdit.tipo;
                    submitBtn.textContent = 'Atualizar Lançamento';
                    cancelBtn.style.display = 'inline-block';
                    showNotification('Formulário preenchido para edição de lançamento.');
                }
            } else {
                showNotification('Tipo de item desconhecido para edição.', true);
                return;
            }
            if (!itemToEdit) {
                showNotification(`Não foi possível encontrar o ${type} para edição.`, true);
            }
        };
        
        // --- RELATORIOS ---
        document.getElementById('btn-gerar-relatorio').addEventListener('click', () => {
            const startDateStr = document.getElementById('relatorio-inicio').value;
            const endDateStr = document.getElementById('relatorio-fim').value;
            const reportContainer = document.getElementById('relatorio-container');
            
            if (!startDateStr || !endDateStr) {
                showNotification('Por favor, selecione as datas de início e fim para o relatório.', true);
                reportContainer.classList.add('hidden');
                return;
            }

            const startDate = new Date(startDateStr + 'T00:00:00');
            const endDate = new Date(endDateStr + 'T23:59:59'); // Include full end day

            if (startDate > endDate) {
                showNotification('A data de início não pode ser posterior à data de fim.', true);
                reportContainer.classList.add('hidden');
                return;
            }

            const filteredSales = vendas.filter(sale => {
                const saleDate = new Date(sale.data + 'T00:00:00');
                return saleDate >= startDate && saleDate <= endDate;
            });

            let totalSalesAmount = 0;
            let totalItemsSold = 0;
            const salesByPaymentMethod = {};

            filteredSales.forEach(sale => {
                totalSalesAmount += sale.total;
                sale.itens.forEach(item => {
                    totalItemsSold += item.quantidade;
                });
                salesByPaymentMethod[sale.metodoPagamento] = (salesByPaymentMethod[sale.metodoPagamento] || 0) + sale.total;
            });

            document.getElementById('relatorio-periodo').textContent = `${formatDate(startDateStr)} a ${formatDate(endDateStr)}`;
            document.getElementById('relatorio-total-vendas').textContent = formatCurrency(totalSalesAmount);
            document.getElementById('relatorio-total-itens').textContent = totalItemsSold;

            const paymentMethodList = document.getElementById('relatorio-metodo-pagamento');
            paymentMethodList.innerHTML = '';
            for (const method in salesByPaymentMethod) {
                let methodName = '';
                switch(method) {
                    case 'vista': methodName = 'À Vista'; break;
                    case 'pix': methodName = 'Pix'; break;
                    case 'fiado': methodName = 'Fiado'; break;
                    case 'parcelado': methodName = 'Parcelado'; break;
                    default: methodName = method;
                }
                const listItem = document.createElement('li');
                listItem.textContent = `${methodName}: ${formatCurrency(salesByPaymentMethod[method])}`;
                paymentMethodList.appendChild(listItem);
            }
            reportContainer.classList.remove('hidden');
            showNotification('Relatório gerado com sucesso!');
        });

        // --- BACKUP/RESTORE FUNCTIONS ---
        const backupData = () => {
            const data = {
                clientes: clientes,
                produtos: produtos,
                vendas: vendas,
                contasAReceber: contasAReceber,
                fluxoCaixa: fluxoCaixa,
                theme: localStorage.getItem('theme') // Include current theme
            };
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `flordemaira_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('Backup realizado com sucesso!');
        };

        const restoreData = (event) => {
            const file = event.target.files[0];
            if (!file) {
                showNotification('Nenhum arquivo selecionado.', true);
                return;
            }

            if (!confirm('Tem certeza que deseja restaurar o backup? Isso substituirá todos os dados atuais do sistema!')) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const restoredData = JSON.parse(e.target.result);
                    
                    // Clear existing data (optional, but safer for full restore)
                    localStorage.clear();

                    // Restore data to arrays and localStorage
                    clientes = restoredData.clientes || [];
                    produtos = restoredData.produtos || [];
                    vendas = restoredData.vendas || [];
                    contasAReceber = restoredData.contasAReceber || [];
                    fluxoCaixa = restoredData.fluxoCaixa || [];
                    
                    saveData('clientes', clientes);
                    saveData('produtos', produtos);
                    saveData('vendas', vendas);
                    saveData('contasAReceber', contasAReceber);
                    saveData('fluxoCaixa', fluxoCaixa);

                    if (restoredData.theme) {
                        applyTheme(restoredData.theme);
                    }

                    showNotification('Backup restaurado com sucesso! Recarregando o sistema...');
                    setTimeout(() => {
                        // Reinitialize the app to reflect restored data
                        window.location.reload(); 
                    }, 1000);

                } catch (error) {
                    console.error('Erro ao restaurar backup:', error);
                    showNotification('Erro ao processar o arquivo de backup. Verifique se é um JSON válido.', true);
                }
            };
            reader.readAsText(file);
        };


        // --- INICIALIZAÇÃO ---
        const init = () => {
            clientes = loadData('clientes');
            produtos = loadData('produtos');
            vendas = loadData('vendas');
            contasAReceber = loadData('contasAReceber');
            fluxoCaixa = loadData('fluxoCaixa');
            
            // Set initial value for a/c parcelas to 2x if it doesn't exist
            if (!document.getElementById('venda-parcelas').value) {
                document.getElementById('venda-parcelas').value = '2';
            }

            const lastPageId = localStorage.getItem('lastActivePage');
            navigateToPage(lastPageId); // Render initial page
            loadTheme(); // Apply theme on init
        };
        
        // --- EVENT LISTENERS ---
        loginForm.addEventListener('submit', e => { 
            e.preventDefault(); 
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const errorMessageEl = document.getElementById('error-message');

            if (usernameInput.value === 'maira' && passwordInput.value === 'flor123') { 
                localStorage.setItem('isLoggedIn', 'true'); 
                loginScreen.classList.add('hidden'); 
                dashboardScreen.classList.remove('hidden'); 
                init(); 
                errorMessageEl.textContent = ''; // Clear error message on success
            } else { 
                errorMessageEl.textContent = 'Usuário ou senha inválidos.';
                showNotification('Falha no login. Verifique suas credenciais.', true);
                usernameInput.value = ''; 
                passwordInput.value = '';
                usernameInput.focus();
            }
        });
        
        logoutBtn.addEventListener('click', () => {
            if (paymentChartInstance) { paymentChartInstance.destroy(); paymentChartInstance = null; }
            localStorage.clear(); // Clear all local storage
            clientes = []; produtos = []; vendas = []; contasAReceber = []; fluxoCaixa = []; carrinhoVenda = []; // Reset data arrays
            dashboardScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            document.getElementById('username').value = ''; // Clear login fields
            document.getElementById('password').value = '';
            document.getElementById('error-message').textContent = '';
        });
        
        navLinks.forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                navigateToPage(link.getAttribute('data-target'));
                if(window.innerWidth <= 768) sidebar.classList.remove('open');
            });
        });
        
        menuToggle.addEventListener('click', (e) => { e.stopPropagation(); sidebar.classList.toggle('open'); });
        mainContent.addEventListener('click', () => { if (sidebar.classList.contains('open')) sidebar.classList.remove('open'); });
        
        // Theme switchers sync
        themeSwitcherMain.addEventListener('change', () => applyTheme(themeSwitcherMain.checked ? 'dark' : 'light'));
        themeSwitcherSettings.addEventListener('change', () => applyTheme(themeSwitcherSettings.checked ? 'dark' : 'light'));


        // CLIENTES CRUD EVENTS
        document.getElementById('form-add-cliente').addEventListener('submit', e => { 
            e.preventDefault(); 
            const id = document.getElementById('cliente-id').value;
            const nome = document.getElementById('nome-cliente').value;
            const contato = document.getElementById('contato-cliente').value;

            if (id) { // Editing existing client
                const index = clientes.findIndex(c => c.id == id);
                if (index !== -1) {
                    clientes[index] = { ...clientes[index], nome, contato };
                    showNotification('Cliente atualizado!');
                }
            } else { // Adding new client
                clientes.push({ id: Date.now(), nome, contato }); 
                showNotification('Cliente salvo!'); 
            }
            saveData('clientes', clientes); 
            renderClientes(); 
            popularFormulariosVenda(); 
        });

        document.getElementById('btn-cancelar-cliente').addEventListener('click', () => resetForm('form-add-cliente', 'cliente'));

        document.getElementById('tabela-clientes-container').addEventListener('click', e => {
            const target = e.target;
            const id = parseInt(target.getAttribute('data-id'));
            const type = target.getAttribute('data-type');
            if (target.classList.contains('btn-edit') && type === 'cliente') {
                editItem(id, type);
            } else if (target.classList.contains('btn-delete') && type === 'cliente') {
                deleteItem(id, type);
            }
        });

        // PRODUTOS CRUD EVENTS
        document.getElementById('form-add-produto').addEventListener('submit', e => { 
            e.preventDefault(); 
            const id = document.getElementById('produto-id').value;
            const nome = document.getElementById('nome-produto').value;
            const quantidade = parseInt(document.getElementById('qtd-produto').value);
            const preco = parseFloat(document.getElementById('preco-produto').value);

            if (isNaN(quantidade) || quantidade < 0) { showNotification('Quantidade deve ser um número não negativo.', true); return; }
            if (isNaN(preco) || preco <= 0) { showNotification('Preço deve ser um número positivo.', true); return; }

            if (id) { // Editing existing product
                const index = produtos.findIndex(p => p.id == id);
                if (index !== -1) {
                    produtos[index] = { ...produtos[index], nome, quantidade, preco };
                    showNotification('Produto atualizado!');
                }
            } else { // Adding new product
                produtos.push({ id: Date.now(), nome, quantidade, preco }); 
                showNotification('Produto salvo!'); 
            }
            saveData('produtos', produtos); 
            renderProdutos(); 
            popularFormulariosVenda(); // Update product dropdowns
            populateUpdateStockProductSelect(); // Update stock product dropdown
        });

        document.getElementById('btn-cancelar-produto').addEventListener('click', () => resetForm('form-add-produto', 'produto'));

        document.getElementById('tabela-produtos-container').addEventListener('click', e => {
            const target = e.target;
            const id = parseInt(target.getAttribute('data-id'));
            const type = target.getAttribute('data-type');
            if (target.classList.contains('btn-edit') && type === 'produto') {
                editItem(id, type);
            } else if (target.classList.contains('btn-delete') && type === 'produto') {
                deleteItem(id, type);
            }
        });

        // UPDATE STOCK EVENTS
        document.getElementById('form-update-stock').addEventListener('submit', e => {
            e.preventDefault();
            const productId = parseInt(document.getElementById('update-stock-product').value);
            const quantity = parseInt(document.getElementById('update-stock-quantity').value);
            const type = document.getElementById('update-stock-type').value;

            if (!productId || isNaN(quantity) || quantity <= 0) {
                showNotification('Selecione um produto e insira uma quantidade válida.', true);
                return;
            }

            const productIndex = produtos.findIndex(p => p.id === productId);
            if (productIndex === -1) {
                showNotification('Produto não encontrado.', true);
                return;
            }

            if (type === 'add') {
                produtos[productIndex].quantidade += quantity;
                showNotification(`Estoque de ${produtos[productIndex].nome} aumentado em ${quantity}.`);
            } else if (type === 'remove') {
                if (produtos[productIndex].quantidade < quantity) {
                    showNotification(`Não é possível remover ${quantity} unidades. Apenas ${produtos[productIndex].quantidade} em estoque.`, true);
                    return;
                }
                produtos[productIndex].quantidade -= quantity;
                showNotification(`Estoque de ${produtos[productIndex].nome} diminuído em ${quantity}.`);
            }

            saveData('produtos', produtos);
            renderProdutos();
            populateUpdateStockProductSelect(); // Re-populate to show updated quantities
            e.target.reset();
            document.getElementById('update-stock-quantity').value = 1;
        });

        // FLUXO DE CAIXA CRUD EVENTS
        document.getElementById('form-add-lancamento').addEventListener('submit', e => { 
            e.preventDefault(); 
            const id = document.getElementById('lancamento-id').value;
            const desc = document.getElementById('desc-lancamento').value; 
            const valor = parseFloat(document.getElementById('valor-lancamento').value); 
            const tipo = document.getElementById('tipo-lancamento').value; 

            if(!desc || isNaN(valor) || valor <= 0){ 
                showNotification('Preencha todos os campos corretamente (valor deve ser positivo)!', true); 
                return;
            }

            if (id) { // Editing existing lancamento
                const index = fluxoCaixa.findIndex(l => l.id == id);
                if (index !== -1) {
                    fluxoCaixa[index] = { ...fluxoCaixa[index], descricao: desc, valor, tipo };
                    showNotification('Lançamento atualizado!');
                }
            } else { // Adding new lancamento
                fluxoCaixa.push({ id: Date.now(), data: new Date().toISOString().split('T')[0], tipo, descricao: desc, valor }); 
                showNotification('Lançamento realizado!'); 
            }
            saveData('fluxoCaixa', fluxoCaixa); 
            renderFluxoCaixa(); 
            renderDashboardSummaries(); // Refresh dashboard balance
        });

        document.getElementById('btn-cancelar-lancamento').addEventListener('click', () => resetForm('form-add-lancamento', 'lancamento'));

        document.getElementById('tabela-caixa-container').addEventListener('click', e => {
            const target = e.target;
            const id = parseInt(target.getAttribute('data-id'));
            const type = target.getAttribute('data-type');
            if (target.classList.contains('btn-edit') && type === 'lancamento') {
                editItem(id, type);
            } else if (target.classList.contains('btn-delete') && type === 'lancamento') {
                deleteItem(id, type);
            }
        });

        // VENDAS EVENTS
        document.getElementById('btn-add-item-venda').addEventListener('click', addItemAoCarrinho);
        document.getElementById('venda-itens-container').addEventListener('click', e => { 
            if(e.target.classList.contains('btn-delete')) { 
                const id = parseInt(e.target.getAttribute('data-id')); 
                carrinhoVenda = carrinhoVenda.filter(item => item.produtoId !== id); 
                renderCarrinho(); 
                showNotification('Item removido do carrinho.');
            } 
        });
        document.getElementById('venda-pagamento').addEventListener('change', e => {
            document.getElementById('venda-parcelas-group').classList.toggle('hidden', e.target.value !== 'parcelado');
        });
        document.getElementById('btn-finalizar-venda').addEventListener('click', finalizarVenda);
        
        // CONTAS A RECEBER EVENTS
        document.getElementById('tabela-contas-container').addEventListener('click', e => {
            if(e.target.classList.contains('btn-paid')) {
                const id = parseInt(e.target.getAttribute('data-id'));
                const conta = contasAReceber.find(c => c.id === id);
                if(conta && conta.status === 'Pendente') {
                    if (!confirm(`Confirmar o recebimento de ${formatCurrency(conta.valor)} da conta nº ${id}?`)) return;
                    conta.status = 'Pago';
                    const clienteNome = clientes.find(c => c.id === conta.clienteId)?.nome || 'Avulso';
                    fluxoCaixa.push({ id: Date.now(), data: new Date().toISOString(), tipo: 'Entrada', descricao: `Recebimento de ${clienteNome} (Conta #${conta.vendaId})`, valor: conta.valor });
                    saveData('contasAReceber', contasAReceber);
                    saveData('fluxoCaixa', fluxoCaixa);
                    renderContasAReceber();
                    renderDashboardSummaries(); // Refresh dashboard totals
                    showNotification('Baixa realizada e valor lançado no caixa!');
                } else {
                    showNotification('Esta conta já foi paga.', true);
                }
            }
        });

        // BACKUP/RESTORE BUTTONS
        document.getElementById('btn-backup-data').addEventListener('click', backupData);
        document.getElementById('btn-restore-data').addEventListener('click', () => {
            document.getElementById('backup-file-input').click(); // Trigger file input click
        });
        document.getElementById('backup-file-input').addEventListener('change', restoreData);
        
        // Initial load check
        if (localStorage.getItem('isLoggedIn') === 'true') {
            dashboardScreen.classList.remove('hidden');
            init();
        } else {
            loginScreen.classList.remove('hidden');
            document.getElementById('username').focus();
        }
    });
    </script>
</body>
</html>
